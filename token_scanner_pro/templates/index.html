<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Token Scanner Pro üöÄ</title>
    <meta name="description" content="Scannez, analysez et tradez les tokens crypto avant tout le monde. IA + Analyse en temps r√©el.">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: rgba(26, 26, 36, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
            --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-gold: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b2;
            --text-tertiary: #6b6b80;
            --accent-primary: #667eea;
            --accent-success: #20e3b2;
            --accent-danger: #f5576c;
            --border-subtle: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Welcome Section */
        .welcome {
            margin-bottom: 2rem;
        }

        .welcome h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        /* Stats Overview Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-change.positive {
            background: rgba(32, 227, 178, 0.1);
            color: var(--accent-success);
        }

        .stat-change.negative {
            background: rgba(245, 87, 108, 0.1);
            color: var(--accent-danger);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text-primary);
            backdrop-filter: blur(20px);
        }

        .action-btn:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .action-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .action-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Scanner Section */
        .scanner-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scan-config {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            padding: 0.75rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Recent Activity */
        .activity-feed {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Auto-Scan Preview */
        .autoscan-preview {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
            margin-bottom: 2rem;
        }

        .autoscan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(32, 227, 178, 0.1);
            border: 1px solid var(--accent-success);
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-success);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .tokens-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .token-card-mini {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s;
        }

        .token-card-mini:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--bg-glass);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .welcome h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-page="home">
    <!-- Navigation Component -->
    {% include 'components_nav.html' %}

    <!-- Barre de progression Auto-Scan (Discr√®te) -->
    {% include 'components_scan_progress.html' %}

    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome">
            <h1>üëã Bienvenue, <span id="welcome-name">Trader</span></h1>
            <p>Votre tableau de bord personnalis√© pour le trading crypto intelligent</p>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Scans Effectu√©s</span>
                    <span class="stat-icon">üîç</span>
                </div>
                <div class="stat-value" id="total-scans">0</div>
                <div class="stat-subtitle">
                    <span class="stat-change positive" style="display: none;">
                        <span>‚Üë</span>
                        <span id="scans-change">0%</span>
                    </span>
                    <span>Cette semaine</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Mes Favoris</span>
                    <span class="stat-icon">‚≠ê</span>
                </div>
                <div class="stat-value" id="total-favorites">0</div>
                <div class="stat-subtitle">Tokens surveill√©s</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Tokens Cach√©s</span>
                    <span class="stat-icon">üóÑÔ∏è</span>
                </div>
                <div class="stat-value" id="cache-tokens">0</div>
                <div class="stat-subtitle">Auto-scan 24h</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Alertes Actives</span>
                    <span class="stat-icon">üö®</span>
                </div>
                <div class="stat-value" id="active-alerts">0</div>
                <div class="stat-subtitle" id="alerts-subtitle">Premium requis</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="#scanner" class="action-btn" onclick="scrollToScanner(); return false;">
                <span class="action-icon">üöÄ</span>
                <div class="action-title">Scan Rapide</div>
                <div class="action-desc">Analyser un token</div>
            </a>

            <a href="/auto-scan" class="action-btn">
                <span class="action-icon">ü§ñ</span>
                <div class="action-title">Auto-Scan</div>
                <div class="action-desc">Scanner 24/7</div>
            </a>

            <a href="/favorites" class="action-btn">
                <span class="action-icon">‚≠ê</span>
                <div class="action-title">Favoris</div>
                <div class="action-desc">Mes tokens</div>
            </a>

            <a href="/dashboard" class="action-btn">
                <span class="action-icon">üíº</span>
                <div class="action-title">Trading</div>
                <div class="action-desc">Bot & positions</div>
            </a>
        </div>

        <!-- Auto-Scan Preview -->
        <div class="autoscan-preview" id="autoscan-preview" style="display: none;">
            <div class="autoscan-header">
                <div>
                    <h2 class="section-title">ü§ñ Tokens Auto-Scann√©s</h2>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                        Les derniers tokens d√©tect√©s automatiquement
                    </p>
                </div>
                <div>
                    <span class="status-badge">
                        <span class="pulse-dot"></span>
                        <span>Scanner actif</span>
                    </span>
                </div>
            </div>

            <div id="autoscan-tokens" class="tokens-preview"></div>

            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="/auto-scan" class="btn btn-primary">
                    Voir tous les tokens ‚Üí
                </a>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Scanner Section -->
            <div class="scanner-section" id="scanner">
                <div class="section-header">
                    <h2 class="section-title">üîç Scanner un Token</h2>
                </div>

                <div class="scan-config">
                    <div class="input-group">
                        <label for="nitter-url">Instance Nitter</label>
                        <input
                            type="text"
                            id="nitter-url"
                            placeholder="http://localhost:8080"
                            value="http://localhost:8080"
                        >
                    </div>

                    <div class="input-group">
                        <label for="max-tokens">Nombre de tokens</label>
                        <select id="max-tokens">
                            <option value="5">5 tokens</option>
                            <option value="10" selected>10 tokens</option>
                            <option value="20">20 tokens</option>
                            <option value="50">50 tokens</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" id="start-scan-btn" onclick="startScan()" style="width: 100%;">
                    üöÄ D√©marrer le Scan
                </button>

                <!-- Auto-scan countdown indicator -->
                <div id="auto-scan-countdown" style="margin-top: 1rem; text-align: center; padding: 0.75rem; background: var(--bg-glass); border-radius: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="opacity: 0.6;">‚è∞</span>
                    <span>Prochain scan automatique dans <strong id="countdown-timer" style="color: var(--accent-primary);">5:00</strong></span>
                </div>

                <div id="scan-progress" style="margin-top: 1.5rem; display: none;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">Scan en cours...</p>
                        <p id="scan-status" style="font-size: 0.875rem; color: var(--text-secondary);"></p>
                    </div>
                </div>

                <div id="scan-results" style="margin-top: 1.5rem; display: none;">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-feed">
                <h3 class="section-title" style="margin-bottom: 1rem;">üìä Activit√© R√©cente</h3>
                <div id="activity-list">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>Aucune activit√© r√©cente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load user info and update welcome
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();

                if (data.authenticated && data.user) {
                    const user = data.user;
                    document.getElementById('welcome-name').textContent = user.username;

                    // Update stats
                    document.getElementById('total-scans').textContent = user.scan_count || 0;

                    // Load other stats
                    await loadFavoritesCount();
                    await loadCacheStats();
                    await loadAlertsCount();
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Load favorites count
        async function loadFavoritesCount() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('total-favorites').textContent = data.favorites.length;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load cache stats
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/auto-scan/cache/stats');
                const data = await response.json();
                if (data.success && data.stats) {
                    document.getElementById('cache-tokens').textContent = data.stats.total_tokens || 0;

                    // Show auto-scan preview if cache has tokens
                    if (data.stats.total_tokens > 0) {
                        document.getElementById('autoscan-preview').style.display = 'block';
                        await loadAutoScanPreview();
                    }
                }
            } catch (error) {
                // Auto-scan not available
                console.log('Auto-scan not available');
            }
        }

        // Load auto-scan preview
        async function loadAutoScanPreview() {
            try {
                const response = await fetch('/api/auto-scan/tokens/recent?limit=6');
                const data = await response.json();

                if (data.success && data.tokens.length > 0) {
                    const container = document.getElementById('autoscan-tokens');
                    container.innerHTML = '';

                    data.tokens.slice(0, 6).forEach(token => {
                        const card = document.createElement('div');
                        card.className = 'token-card-mini';
                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; font-size: 0.875rem;">${token.chain.toUpperCase()}</div>
                                <div style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.5rem; ${token.is_safe ? 'background: rgba(32, 227, 178, 0.1); color: #20e3b2;' : 'background: rgba(245, 87, 108, 0.1); color: #f5576c;'}">
                                    ${token.is_safe ? '‚úÖ S√ªr' : '‚ö†Ô∏è Risqu√©'}
                                </div>
                            </div>
                            <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                ${token.address.substring(0, 8)}...${token.address.substring(token.address.length - 6)}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Risk: ${token.risk_score}/100
                            </div>
                        `;
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            window.location.href = `/auto-scan`;
                        });
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load alerts count (placeholder)
        async function loadAlertsCount() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                if (data.authenticated && data.user && data.user.is_premium) {
                    document.getElementById('active-alerts').textContent = '0';
                    document.getElementById('alerts-subtitle').textContent = 'Aucune alerte';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Scroll to scanner
        function scrollToScanner() {
            document.getElementById('scanner').scrollIntoView({ behavior: 'smooth' });
        }

        // Start scan
        async function startScan() {
            // Reset auto-scan countdown to 5 minutes when manual scan starts
            if (typeof secondsRemaining !== 'undefined') {
                secondsRemaining = 300;
                updateCountdown();
            }

            const nitterUrl = document.getElementById('nitter-url').value;
            const maxTokens = parseInt(document.getElementById('max-tokens').value);

            const btn = document.getElementById('start-scan-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Scan en cours...';

            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-results').style.display = 'none';

            try {
                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nitter_url: nitterUrl,
                        max_tokens: maxTokens
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Poll for results
                    pollScanResults();
                } else {
                    alert('Erreur: ' + (data.error || '√âchec du scan'));
                    btn.disabled = false;
                    btn.textContent = 'üöÄ D√©marrer le Scan';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                alert('Erreur r√©seau');
                btn.disabled = false;
                btn.textContent = 'üöÄ D√©marrer le Scan';
                document.getElementById('scan-progress').style.display = 'none';
            }
        }

        // Poll scan results
        async function pollScanResults() {
            try {
                const response = await fetch('/api/scan/progress');
                const data = await response.json();

                if (data.in_progress) {
                    document.getElementById('scan-status').textContent = data.message || 'Analyse en cours...';
                    setTimeout(pollScanResults, 2000);
                } else {
                    // Scan complete
                    const resultsResponse = await fetch('/api/scan/results');
                    const resultsData = await resultsResponse.json();

                    displayScanResults(resultsData);

                    const btn = document.getElementById('start-scan-btn');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ D√©marrer le Scan';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Error polling:', error);
                setTimeout(pollScanResults, 2000);
            }
        }

        // Display scan results - ENHANCED WITH ALL AVAILABLE DATA
        function displayScanResults(data) {
            const container = document.getElementById('scan-results');
            container.style.display = 'block';

            console.log('üìä Displaying scan results:', data);

            if (data.results && data.results.length > 0) {
                // Build enriched tokens list
                const tokensHTML = data.results.map((token, index) => {
                    const hasMarketData = token.market && !token.market.error;
                    const hasSecurity = token.security && !token.security.error;
                    const hasTwitter = token.twitter_data && !token.twitter_data.error;

                    // Price & changes
                    const price = hasMarketData ? token.market.price_usd : 0;
                    const change24h = hasMarketData ? (token.market.price_change_24h || 0) : 0;
                    const change6h = hasMarketData ? (token.market.price_change_6h || 0) : 0;
                    const change1h = hasMarketData ? (token.market.price_change_1h || 0) : 0;

                    // Market data
                    const liquidity = hasMarketData ? (token.market.liquidity_usd || 0) : 0;
                    const volume24h = hasMarketData ? (token.market.volume_24h || 0) : 0;
                    const volume6h = hasMarketData ? (token.market.volume_6h || 0) : 0;
                    const marketCap = hasMarketData ? (token.market.market_cap || 0) : 0;
                    const buys = hasMarketData ? (token.market.txns_24h_buys || 0) : 0;
                    const sells = hasMarketData ? (token.market.txns_24h_sells || 0) : 0;
                    const pairAge = hasMarketData ? token.market.pair_created_at : 'N/A';

                    // Security data
                    const buyTax = hasSecurity ? (token.security.buy_tax || 0) : 0;
                    const sellTax = hasSecurity ? (token.security.sell_tax || 0) : 0;
                    const holders = hasSecurity ? (token.security.holder_count || 'N/A') : 'N/A';
                    const isHoneypot = hasSecurity ? token.security.is_honeypot : false;
                    const isMintable = hasSecurity ? token.security.is_mintable : false;
                    const isOpenSource = hasSecurity ? token.security.is_open_source : false;

                    // Social data
                    const socialScore = token.social_score || 0;
                    const followers = hasTwitter ? (token.twitter_data.followers || 0) : 0;
                    const tweets = hasTwitter ? (token.twitter_data.tweets || 0) : 0;

                    // Pump & Dump data
                    const pumpScore = token.pump_dump_score || 0;
                    const pumpRisk = token.pump_dump_risk || 'UNKNOWN';

                    // Risk score color
                    const riskColor = token.risk_score < 30 ? '#22c55e' :
                                     token.risk_score < 70 ? '#f59e0b' : '#ef4444';
                    const pumpColor = pumpRisk === 'FAIBLE' ? '#22c55e' :
                                      pumpRisk === 'MOYEN' ? '#f59e0b' : '#ef4444';

                    // Format numbers
                    const formatNumber = (num) => {
                        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                        return num.toFixed(2);
                    };

                    const formatPrice = (p) => {
                        if (p >= 1) return '$' + p.toFixed(4);
                        if (p >= 0.0001) return '$' + p.toFixed(6);
                        return '$' + p.toExponential(2);
                    };

                    const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';
                    const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';

                    return `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; backdrop-filter: blur(20px);">
                            <!-- Header with Icon -->
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                                <div style="display: flex; gap: 1rem; align-items: start; flex: 1;">
                                    ${token.icon ? `
                                        <img src="${token.icon}" alt="Token Icon" style="width: 64px; height: 64px; border-radius: 1rem; background: var(--bg-glass); padding: 0.5rem;" onerror="this.style.display='none'">
                                    ` : `
                                        <div style="width: 64px; height: 64px; border-radius: 1rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 2rem;">ü™ô</div>
                                    `}
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">
                                            ${token.description || 'Token ' + (index + 1)}
                                        </h4>
                                        <div style="font-family: monospace; font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                            ${token.address.substring(0, 12)}...${token.address.substring(token.address.length - 8)}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <span style="background: var(--bg-glass); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; text-transform: uppercase; font-weight: 600;">
                                                ${token.chain}
                                            </span>
                                            ${token.is_safe ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">‚úÖ SAFE</span>' : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">‚ö†Ô∏è RISKY</span>'}
                                            ${token.is_pump_dump_suspect ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">üö® P&D</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="background: ${riskColor}; color: white; padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                        Risk ${token.risk_score}/100
                                    </div>
                                    ${hasMarketData ? `
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">
                                            ${formatPrice(price)}
                                        </div>
                                        <div style="color: ${colorChange(change24h)}; font-weight: 600; font-size: 1rem;">
                                            ${formatChange(change24h)} 24h
                                        </div>
                                    ` : '<div style="color: var(--text-tertiary); font-size: 0.875rem;">No price data</div>'}
                                </div>
                            </div>

                            ${!hasMarketData ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                                    <div style="color: #ef4444; font-weight: 600;">
                                        ‚ö†Ô∏è Market data unavailable (API blocked)
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Price Changes -->
                            ${hasMarketData ? `
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">1H Change</div>
                                        <div style="font-size: 1.125rem; font-weight: 700; color: ${colorChange(change1h)};">${formatChange(change1h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">6H Change</div>
                                        <div style="font-size: 1.125rem; font-weight: 700; color: ${colorChange(change6h)};">${formatChange(change6h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">24H Change</div>
                                        <div style="font-size: 1.125rem; font-weight: 700; color: ${colorChange(change24h)};">${formatChange(change24h)}</div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Market Stats Grid -->
                            ${hasMarketData ? `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üíß Liquidity</div>
                                        <div style="font-weight: 700; font-size: 1rem;">$${formatNumber(liquidity)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üìä Volume 24h</div>
                                        <div style="font-weight: 700; font-size: 1rem;">$${formatNumber(volume24h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üìà Volume 6h</div>
                                        <div style="font-weight: 700; font-size: 1rem;">$${formatNumber(volume6h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üíé Market Cap</div>
                                        <div style="font-weight: 700; font-size: 1rem;">$${formatNumber(marketCap)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üü¢ Buys 24h</div>
                                        <div style="font-weight: 700; font-size: 1rem; color: #22c55e;">${buys}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üî¥ Sells 24h</div>
                                        <div style="font-weight: 700; font-size: 1rem; color: #ef4444;">${sells}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">‚è∞ Pair Age</div>
                                        <div style="font-weight: 700; font-size: 0.875rem;">${pairAge !== 'N/A' ? new Date(pairAge * 1000).toLocaleDateString() : 'N/A'}</div>
                                    </div>
                                    ${hasSecurity ? `
                                        <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1rem;">
                                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">üë• Holders</div>
                                            <div style="font-weight: 700; font-size: 1rem;">${holders !== 'N/A' ? formatNumber(parseInt(holders)) : 'N/A'}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <!-- Security Section -->
                            ${hasSecurity ? `
                                <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                                    <h5 style="font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üîí</span> Security Analysis
                                    </h5>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                                            <span style="color: var(--text-secondary);">Buy Tax</span>
                                            <span style="font-weight: 600; color: ${buyTax > 10 ? '#ef4444' : '#22c55e'};">${buyTax.toFixed(1)}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                                            <span style="color: var(--text-secondary);">Sell Tax</span>
                                            <span style="font-weight: 600; color: ${sellTax > 10 ? '#ef4444' : '#22c55e'};">${sellTax.toFixed(1)}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                                            <span style="color: var(--text-secondary);">Honeypot</span>
                                            <span style="font-weight: 600; color: ${isHoneypot ? '#ef4444' : '#22c55e'};">${isHoneypot ? '‚ùå Yes' : '‚úÖ No'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                                            <span style="color: var(--text-secondary);">Mintable</span>
                                            <span style="font-weight: 600; color: ${isMintable ? '#f59e0b' : '#22c55e'};">${isMintable ? '‚ö†Ô∏è Yes' : '‚úÖ No'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                                            <span style="color: var(--text-secondary);">Open Source</span>
                                            <span style="font-weight: 600; color: ${isOpenSource ? '#22c55e' : '#f59e0b'};">${isOpenSource ? '‚úÖ Yes' : '‚ö†Ô∏è No'}</span>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Social & Pump/Dump Scores -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                ${hasTwitter ? `
                                    <div style="background: linear-gradient(135deg, rgba(29, 161, 242, 0.1) 0%, rgba(29, 161, 242, 0.05) 100%); border: 1px solid rgba(29, 161, 242, 0.3); border-radius: 0.75rem; padding: 1.25rem;">
                                        <h5 style="font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span>üê¶</span> Social Score
                                        </h5>
                                        <div style="font-size: 2rem; font-weight: 700; color: #1da1f2; margin-bottom: 0.5rem;">${socialScore}/100</div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-secondary);">
                                            <span>üë• ${formatNumber(followers)} followers</span>
                                            <span>üí¨ ${formatNumber(tweets)} tweets</span>
                                        </div>
                                    </div>
                                ` : ''}
                                <div style="background: linear-gradient(135deg, ${pumpColor}22 0%, ${pumpColor}11 100%); border: 1px solid ${pumpColor}; border-radius: 0.75rem; padding: 1.25rem;">
                                    <h5 style="font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üö®</span> Pump & Dump Risk
                                    </h5>
                                    <div style="font-size: 2rem; font-weight: 700; color: ${pumpColor}; margin-bottom: 0.5rem;">${pumpScore}/100</div>
                                    <div style="font-size: 0.875rem; font-weight: 600; color: ${pumpColor};">${pumpRisk}</div>
                                </div>
                            </div>

                            <!-- Warnings -->
                            ${token.warnings && token.warnings.length > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                                    <div style="font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>‚ö†Ô∏è</span> Risk Warnings
                                    </div>
                                    ${token.warnings.map(w => `<div style="font-size: 0.875rem; margin-bottom: 0.5rem; padding-left: 1.5rem;">‚Ä¢ ${w}</div>`).join('')}
                                </div>
                            ` : ''}

                            ${token.pump_dump_warnings && token.pump_dump_warnings.length > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                                    <div style="font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üö®</span> Pump & Dump Indicators
                                    </div>
                                    ${token.pump_dump_warnings.map(w => `<div style="font-size: 0.875rem; margin-bottom: 0.5rem; padding-left: 1.5rem;">‚Ä¢ ${w}</div>`).join('')}
                                </div>
                            ` : ''}

                            <!-- Action Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <button onclick="analyzeTokenWithAI('${token.address}', '${token.chain}', ${JSON.stringify(token).replace(/'/g, "\\'")}), this)" style="padding: 1rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s;">
                                    <span style="font-size: 1.25rem;">ü§ñ</span>
                                    <span>Scan par IA</span>
                                </button>
                                ${token.url ? `
                                    <a href="${token.url}" target="_blank" style="padding: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s;">
                                        <span style="font-size: 1.25rem;">üìä</span>
                                        <span>DexScreener</span>
                                    </a>
                                ` : ''}
                                ${token.twitter ? `
                                    <a href="${token.twitter}" target="_blank" style="padding: 1rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s;">
                                        <span style="font-size: 1.25rem;">üê¶</span>
                                        <span>Twitter</span>
                                    </a>
                                ` : ''}
                            </div>

                            <!-- AI Analysis Result -->
                            <div id="ai-result-${token.address}" style="display: none; margin-top: 1.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                    <span style="font-size: 1.5rem;">ü§ñ</span>
                                    <h5 style="font-weight: 700; font-size: 1.125rem;">Analyse Claude IA</h5>
                                </div>
                                <div id="ai-content-${token.address}" style="color: var(--text-secondary); line-height: 1.8; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid var(--accent-primary); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                        <h3 style="font-size: 1.75rem; font-weight: 900; margin-bottom: 0.5rem;">‚úÖ Scan Termin√© !</h3>
                        <p style="color: var(--text-secondary); font-size: 1.125rem;">
                            ${data.results.length} token(s) analys√©(s) ‚Ä¢
                            <span style="color: #22c55e; font-weight: 600;">${data.safe_count || 0} s√ªrs</span> ‚Ä¢
                            <span style="color: #ef4444; font-weight: 600;">${data.dangerous_count || 0} risqu√©s</span> ‚Ä¢
                            <span style="color: #f59e0b; font-weight: 600;">${data.pump_dump_suspects_count || 0} P&D suspects</span>
                        </p>
                    </div>
                    ${tokensHTML}
                `;

                // Refresh stats
                loadUserInfo();
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ü§∑</div>
                        <p>Aucun token trouv√©</p>
                    </div>
                `;
            }
        }

        // AI Token Analysis
        async function analyzeTokenWithAI(address, chain, tokenData, buttonElement) {
            const resultDiv = document.getElementById(`ai-result-${address}`);
            const contentDiv = document.getElementById(`ai-content-${address}`);

            // Show loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span>‚è≥</span><span>Analyse en cours...</span>';
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><div style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 0.5rem;">Claude analyse le token...</p></div>';

            try {
                const response = await fetch('/api/analyze-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        chain: chain,
                        token_data: tokenData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    contentDiv.innerHTML = data.analysis || 'Analyse termin√©e.';
                } else {
                    contentDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Erreur: ${data.error || 'Impossible d\'analyser le token'}</div>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Erreur de connexion: ${error.message}</div>`;
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<span>ü§ñ</span><span>Scan par IA</span>';
            }
        }

        // ==================== AUTO-SCAN SYSTEM ====================
        let autoScanInterval = null;
        let countdownInterval = null;
        let secondsRemaining = 300; // 5 minutes = 300 seconds

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateCountdown() {
            const timerElement = document.getElementById('countdown-timer');
            if (timerElement) {
                timerElement.textContent = formatTime(secondsRemaining);

                // Color change based on time remaining
                if (secondsRemaining <= 30) {
                    timerElement.style.color = '#ef4444'; // Red when <30s
                } else if (secondsRemaining <= 60) {
                    timerElement.style.color = '#f59e0b'; // Orange when <1min
                } else {
                    timerElement.style.color = 'var(--accent-primary)'; // Normal
                }
            }

            secondsRemaining--;

            if (secondsRemaining < 0) {
                // Time's up! Trigger auto-scan
                secondsRemaining = 300; // Reset to 5 minutes
                triggerAutoScan();
            }
        }

        async function triggerAutoScan() {
            console.log('ü§ñ Auto-scan triggered!');

            // Check if already scanning
            const btn = document.getElementById('start-scan-btn');
            if (btn.disabled) {
                console.log('‚è∏Ô∏è Scan already in progress, skipping auto-scan');
                return;
            }

            // Trigger scan with notification
            const countdownDiv = document.getElementById('auto-scan-countdown');
            const originalHTML = countdownDiv.innerHTML;

            // Show auto-scan message
            countdownDiv.innerHTML = `
                <span>ü§ñ</span>
                <span>Scan automatique en cours...</span>
            `;
            countdownDiv.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2))';
            countdownDiv.style.borderColor = 'var(--accent-primary)';

            // Start scan
            await startScan();

            // Wait a bit before resetting display
            setTimeout(() => {
                countdownDiv.innerHTML = originalHTML;
                countdownDiv.style.background = 'var(--bg-glass)';
                countdownDiv.style.borderColor = '';
            }, 3000);
        }

        function startAutoScanSystem() {
            console.log('üöÄ Auto-scan system initialized (5-minute intervals)');

            // Start countdown
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdown, 1000);

            // Initial countdown display
            updateCountdown();
        }

        function stopAutoScanSystem() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            console.log('‚èπÔ∏è Auto-scan system stopped');
        }

        // Initialize
        loadUserInfo();
        startAutoScanSystem();

        // Stop auto-scan when user leaves page
        window.addEventListener('beforeunload', () => {
            stopAutoScanSystem();
        });
    </script>

    <!-- Auth Modal (Login/Register) -->
    {% include 'components_auth_modal.html' %}
</body>
</html>
