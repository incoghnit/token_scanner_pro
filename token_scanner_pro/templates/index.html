<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>Token Scanner Pro 🚀 - Détectez les Opportunités Crypto Avant Tout le Monde</title>
    <meta name="title" content="Token Scanner Pro 🚀 - Détectez les Opportunités Crypto Avant Tout le Monde">
    <meta name="description" content="Scanner IA professionnel avec analyse en temps réel, détection pump & dump, et auto-scan 24/7. Analysez les tokens crypto avec l'intelligence artificielle Claude.">
    <meta name="keywords" content="crypto scanner, token scanner, pump dump detector, crypto analysis, IA crypto, blockchain scanner, DeFi tools, crypto trading">
    <meta name="author" content="Token Scanner Pro">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tokenscannerpro.com/">
    <meta property="og:title" content="Token Scanner Pro 🚀 - Détectez les Opportunités Crypto Avant Tout le Monde">
    <meta property="og:description" content="Scanner IA professionnel avec analyse en temps réel, détection pump & dump, et auto-scan 24/7. Prenez des décisions éclairées grâce à l'intelligence artificielle.">
    <meta property="og:image" content="https://tokenscannerpro.com/static/og-image.jpg">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:site_name" content="Token Scanner Pro">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://tokenscannerpro.com/">
    <meta name="twitter:title" content="Token Scanner Pro 🚀 - Détectez les Opportunités Crypto Avant Tout le Monde">
    <meta name="twitter:description" content="Scanner IA professionnel avec analyse en temps réel, détection pump & dump, et auto-scan 24/7.">
    <meta name="twitter:image" content="https://tokenscannerpro.com/static/og-image.jpg">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

    <!-- Theme Color -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: rgba(26, 26, 36, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
            --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-gold: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b2;
            --text-tertiary: #6b6b80;
            --accent-primary: #667eea;
            --accent-success: #20e3b2;
            --accent-danger: #f5576c;
            --border-subtle: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Prevent all elements from overflowing */
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* Ensure all flex and grid containers don't overflow */
        div, section, article, aside, header, footer, nav {
            max-width: 100%;
        }

        /* Ensure images and iframes are responsive */
        img, iframe {
            max-width: 100%;
            height: auto;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Welcome Section */
        .welcome {
            margin-bottom: 2rem;
        }

        .welcome h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        /* Stats Overview Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-change.positive {
            background: rgba(32, 227, 178, 0.1);
            color: var(--accent-success);
        }

        .stat-change.negative {
            background: rgba(245, 87, 108, 0.1);
            color: var(--accent-danger);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Scanner Section */
        .scanner-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
            max-width: 100%;
            overflow-x: hidden; /* Prevent horizontal scroll in scanner section */
        }

        /* Scan results container - prevent overflow */
        #scan-results {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
        }

        /* Token cards - constrain width */
        #scan-results > div {
            max-width: 100%;
            overflow: hidden;
        }

        /* Token stats grid - make responsive */
        #scan-results div[style*="grid-template-columns: repeat(4, 1fr)"] {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 0.5rem !important;
        }

        /* Reduce to 2 columns on medium screens */
        @media (max-width: 1200px) {
            #scan-results div[style*="grid-template-columns: repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* Prevent long text overflow in token cards */
        #scan-results div[style*="font-family: monospace"] {
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* Constrain activity feed sections too */
        .activity-feed {
            max-width: 100%;
            overflow-x: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scan-config {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            padding: 0.75rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Recent Activity */
        .activity-feed {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Auto-Scan styles removed - feature not useful */

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--bg-glass);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            10%, 90% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .welcome h1 {
                font-size: 2rem;
            }

            /* Responsive layout 2 colonnes → 1 colonne sur petits écrans */
            .main-grid > div[style*="grid-template-columns: 400px 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Désactiver sticky sur mobile */
            .main-grid [style*="position: sticky"] {
                position: relative !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                max-width: 100vw; /* Prevent overflow */
            }

            .welcome h1 {
                font-size: 1.75rem;
            }

            .welcome p {
                font-size: 1rem !important;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            /* Token cards grid - 1 column on mobile */
            .tokens-grid {
                grid-template-columns: 1fr !important;
            }

            /* Search input stack on mobile */
            #token-search-input {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }

            /* Prevent section overflow */
            .scanner-section,
            .activity-feed {
                padding: 1rem !important;
                max-width: 100%;
                overflow-x: hidden;
            }

            /* Main grid responsive */
            .main-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 0.75rem;
                max-width: 100vw;
            }

            .welcome {
                padding: 1.5rem 1rem !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .welcome h1 {
                font-size: 1.5rem !important;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.75rem !important;
            }

            /* Modal responsive */
            #token-details-modal > div {
                padding: 1rem !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }

            #token-details-modal {
                padding: 0 !important;
            }

            /* Token cards - reduce padding on mobile */
            #scan-results > div {
                padding: 0.75rem !important;
            }

            /* Reduce all section paddings */
            .scanner-section,
            .activity-feed,
            .stat-card {
                padding: 0.75rem !important;
            }
        }

        /* Amélioration responsive pour les petits écrans */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }

            .section-title {
                font-size: 1.125rem;
            }

            /* Search form stack */
            .search-form {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            .search-btn {
                width: 100% !important;
                padding: 1rem !important;
            }

            /* Welcome section - very compact on tiny screens */
            .welcome {
                padding: 1rem 0.75rem !important;
            }

            /* All sections compact */
            .scanner-section,
            .activity-feed,
            .stat-card {
                padding: 0.5rem !important;
                border-radius: 0.75rem !important;
            }

            /* Reduce gaps everywhere */
            .stats-grid,
            .main-grid {
                gap: 0.75rem !important;
            }

            /* Buttons smaller */
            .btn {
                padding: 0.6rem 1rem !important;
                font-size: 0.8rem !important;
            }

            /* Force word break in long addresses */
            div[style*="font-family: monospace"] {
                word-break: break-all;
            }

            /* News refresh button */
            .activity-feed > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }
        }
    </style>

    <!-- Reusable Component Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='components.css') }}">

    <!-- Socket.IO for Real-time Token Discovery -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body data-page="home">
    <!-- Navigation Component -->
    {% include 'components_nav.html' %}

    <!-- Barre de progression Auto-Scan (Discrète) -->
    {% include 'components_scan_progress.html' %}

    <div class="container">
        <!-- 🔍 Token Search Bar (Above Everything) -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">🔍</span>
                <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0;">Rechercher un Token</h3>
            </div>

            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem;">
                <input
                    type="text"
                    id="tokenSearchInput"
                    placeholder="Entrez une adresse de token ou URL DexScreener..."
                    style="padding: 1rem 1.25rem; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; color: var(--text-primary); font-size: 0.95rem; width: 100%; transition: all 0.2s;"
                    onkeypress="if(event.key === 'Enter') searchSpecificToken()"
                    onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'"
                    onblur="this.style.borderColor='var(--border-subtle)'; this.style.boxShadow='none'"
                />
                <button
                    onclick="searchSpecificToken()"
                    style="padding: 1rem 2rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);"
                    onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)'"
                    onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'"
                >
                    🚀 Analyser
                </button>
            </div>

            <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-tertiary);">
                💡 <strong>Astuce:</strong> Collez une adresse de token ou une URL DexScreener complète (ex: https://dexscreener.com/solana/abc123...)
            </div>
        </div>

        <!-- 📊 Manual Scan Progress & Results (Hidden by default) -->
        <div id="scan-progress" style="display: none; background: var(--bg-card); border: 2px solid var(--accent-primary); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <div class="spinner" style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite;"></div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; margin-bottom: 0.25rem;">🔍 Analyse en cours...</div>
                    <div id="scan-status" style="font-size: 0.85rem; color: var(--text-secondary);">Récupération des données du token...</div>
                </div>
            </div>
        </div>

        <!-- 📋 Manual Scan Results (Hidden by default) -->
        <div id="scan-results" style="display: none; margin-bottom: 2rem;">
            <!-- Results will be populated by JavaScript -->
        </div>

        <!-- Hero Section - Marketing Optimized -->
        <div class="welcome" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border: 1px solid var(--border-subtle); border-radius: 1.5rem; padding: 2rem 1.5rem; margin-bottom: 2rem; text-align: center; backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); position: relative; overflow: hidden;">

            <!-- Decorative elements -->
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%); border-radius: 50%; animation: pulse 4s ease-in-out infinite;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(118, 75, 162, 0.15) 0%, transparent 70%); border-radius: 50%; animation: pulse 3s ease-in-out infinite;"></div>

            <div style="position: relative; z-index: 1;">
                <!-- Badge de bienvenue -->
                <div style="display: inline-block; background: rgba(102, 126, 234, 0.15); border: 1px solid rgba(102, 126, 234, 0.3); padding: 0.5rem 1.25rem; border-radius: 2rem; margin-bottom: 1.5rem; animation: fadeInUp 0.6s ease-out;">
                    <span style="font-weight: 600; font-size: 0.875rem; color: var(--accent-primary);">👋 Bienvenue <span id="welcome-name" style="text-transform: capitalize;">Trader</span></span>
                </div>

                <!-- Hero Title -->
                <h1 style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; margin-bottom: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInUp 0.6s ease-out 0.1s backwards; line-height: 1.2;">
                    Détectez les Opportunités Crypto<br/>Avant Tout le Monde
                </h1>

                <!-- Value Proposition -->
                <p style="color: var(--text-secondary); font-size: clamp(1rem, 2vw, 1.25rem); max-width: 750px; margin: 0 auto 2.5rem; line-height: 1.6; animation: fadeInUp 0.6s ease-out 0.2s backwards;">
                    Scanner IA professionnel avec analyse en temps réel, détection pump & dump, et auto-scan 24/7.
                    <strong style="color: var(--accent-primary);">Prenez des décisions éclairées</strong> grâce à l'intelligence artificielle.
                </p>

                <!-- Value Props Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; max-width: 900px; margin: 0 auto 2.5rem; animation: fadeInUp 0.6s ease-out 0.3s backwards;">
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.25); padding: 1.25rem; border-radius: 1rem; text-align: left;">
                        <div style="font-size: 2rem; margin-bottom: 0.75rem;">🤖</div>
                        <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; color: #22c55e;">Scanner IA Avancé</div>
                        <div style="font-size: 0.8rem; color: var(--text-tertiary); line-height: 1.4;">Analyse intelligente avec détection des risques en temps réel</div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%); border: 1px solid rgba(249, 115, 22, 0.25); padding: 1.25rem; border-radius: 1rem; text-align: left;">
                        <div style="font-size: 2rem; margin-bottom: 0.75rem;">🛡️</div>
                        <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; color: #f97316;">Protection P&D</div>
                        <div style="font-size: 0.8rem; color: var(--text-tertiary); line-height: 1.4;">Détection avancée des pump & dump suspects</div>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(32, 227, 178, 0.1) 0%, rgba(32, 227, 178, 0.05) 100%); border: 1px solid rgba(32, 227, 178, 0.25); padding: 1.25rem; border-radius: 1rem; text-align: left;">
                        <div style="font-size: 2rem; margin-bottom: 0.75rem;">📰</div>
                        <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; color: #20e3b2;">Actualités Temps Réel</div>
                        <div style="font-size: 0.8rem; color: var(--text-tertiary); line-height: 1.4;">News crypto et alertes marché instantanées</div>
                    </div>
                </div>

                <!-- Trust badges -->
                <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 2.5rem; flex-wrap: wrap; animation: fadeInUp 0.6s ease-out 0.5s backwards;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-tertiary); font-size: 0.85rem;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" fill="#22c55e"/></svg>
                        <span>Scanner IA Claude</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-tertiary); font-size: 0.85rem;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 0C4.477 0 0 4.477 0 10s4.477 10 10 10 10-4.477 10-10S15.523 0 10 0zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" fill="#667eea"/><path d="M13.5 7.5L9 12 6.5 9.5" stroke="#667eea" stroke-width="2" stroke-linecap="round"/></svg>
                        <span>Analyse Temps Réel</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-tertiary); font-size: 0.85rem;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2v16M2 10h16" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/></svg>
                        <span>Gratuit & Open Source</span>
                    </div>
                </div>
            </div>
        </div>

        <style>
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 0.5;
                }
                50% {
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }
        </style>

        <!-- Main Layout: 2 colonnes (Sidebar gauche + Contenu principal droite) -->
        <div style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem; align-items: start;">

            <!-- ==================== COLONNE GAUCHE: ACTUALITÉS CRYPTO (STICKY) ==================== -->
            <div style="position: sticky; top: 1rem;">
                <div style="background: linear-gradient(135deg, rgba(32, 227, 178, 0.08) 0%, rgba(12, 235, 235, 0.08) 100%); border: 2px solid var(--border-subtle); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);">
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 class="section-title" style="font-size: 1.3rem; margin-bottom: 0.5rem;">📰 Actualités Crypto</h2>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                News en temps réel du marché
                            </p>
                        </div>
                        <button onclick="refreshNewsSidebar()" style="padding: 0.5rem 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; transition: all 0.2s;">
                            <span id="news-sidebar-refresh-icon">🔄</span>
                        </button>
                    </div>

                    <!-- Liste des news compactes -->
                    <div id="news-sidebar-list" style="max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
                        <div class="loading" style="text-align: center; padding: 2rem;">
                            <div class="spinner" style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-success); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">Chargement...</p>
                        </div>
                    </div>

                    <!-- Scrollbar styling -->
                    <style>
                        #news-sidebar-list::-webkit-scrollbar {
                            width: 6px;
                        }
                        #news-sidebar-list::-webkit-scrollbar-track {
                            background: var(--bg-glass);
                            border-radius: 10px;
                        }
                        #news-sidebar-list::-webkit-scrollbar-thumb {
                            background: var(--accent-success);
                            border-radius: 10px;
                        }
                        #news-sidebar-list::-webkit-scrollbar-thumb:hover {
                            background: #0cebeb;
                        }
                    </style>
                </div>
            </div>

            <!-- ==================== COLONNE DROITE: TOKENS DÉCOUVERTS ==================== -->
            <div>
                <!-- SECTION: DERNIERS TOKENS DÉCOUVERTS (DYNAMIQUE) -->
                <div style="margin-bottom: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 0.5rem;">🆕 Derniers Tokens Découverts</h2>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                Mis à jour automatiquement toutes les 3 minutes • Partagé avec tous les utilisateurs
                            </p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div id="discovery-badge" style="padding: 0.5rem 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.5rem; font-size: 0.85rem; color: #22c55e; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></span>
                                <span id="discovery-badge-text">En attente...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Grille dynamique des nouveaux tokens -->
                    <div id="discovered-tokens-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Loading state -->
                        <div id="discovered-tokens-loading" style="grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;">
                            <div class="spinner" style="border: 4px solid var(--bg-glass); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            <p style="margin-top: 1.5rem; color: var(--text-secondary); font-size: 1rem;">Connexion au service de découverte...</p>
                            <p style="margin-top: 0.5rem; color: var(--text-tertiary); font-size: 0.85rem;">Les tokens apparaîtront automatiquement</p>
                        </div>
                    </div>
                </div>

            </div> <!-- Fin colonne droite -->

        </div> <!-- Fin layout 2 colonnes -->

        <!-- ==================== MODAL DÉTAILS TOKEN ==================== -->
        <div id="token-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 10000; overflow-y: auto; padding: 2rem;" onclick="closeTokenDetailsModal(event)">
            <div style="max-width: 900px; margin: 0 auto; background: var(--bg-secondary); border: 2px solid var(--border-subtle); border-radius: 1.5rem; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); position: relative;" onclick="event.stopPropagation()">
                <!-- Header avec bouton fermer -->
                <div style="display: flex; justify-content: space-between; align-items: start; padding: 2rem; border-bottom: 1px solid var(--border-subtle);">
                    <div id="modal-header-content" style="flex: 1;">
                        <!-- Rempli par JavaScript -->
                    </div>
                    <button onclick="closeTokenDetailsModal()" style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.5rem 1rem; color: var(--text-secondary); cursor: pointer; font-weight: 700; transition: all 0.2s; margin-left: 1rem;">
                        ✕ Fermer
                    </button>
                </div>

                <!-- Contenu du modal -->
                <div id="modal-body-content" style="padding: 2rem;">
                    <!-- Rempli par JavaScript -->
                </div>
            </div>
        </div>

    </div> <!-- Fin main container -->

    <script>
        // ==================== AUTO-DISCOVERY WEBSOCKET ====================
        // Connexion WebSocket pour recevoir les tokens en temps réel
        let socket = null;
        let discoveryActive = false;

        function initializeDiscovery() {
            console.log('🔌 Initialisation Discovery Service...');

            // Connexion Socket.IO
            socket = io(window.location.origin, {
                transports: ['websocket', 'polling']
            });

            // Connexion établie
            socket.on('connect', () => {
                console.log('✅ Connecté au Discovery Service');
                discoveryActive = true;

                // Mettre à jour le badge
                updateDiscoveryBadge('Connecté', 'success');

                // Rejoindre la room discovery
                socket.emit('join_discovery');

                // Charger les tokens existants depuis la BDD
                loadExistingTokens();
            });

            // Nouveau token découvert (temps réel)
            socket.on('new_token', (token) => {
                console.log('📢 Nouveau token découvert:', token);
                addDiscoveredToken(token);
            });

            // Scan démarré
            socket.on('scan_started', (data) => {
                console.log('🔍 Discovery scan démarré...', data);
                updateDiscoveryBadge('Scan en cours...', 'scanning');
                showDiscoveryStatus('🔍 Recherche de nouveaux tokens en cours...');
            });

            // Scan terminé
            socket.on('scan_completed', (data) => {
                console.log('✅ Discovery scan terminé:', data);
                updateDiscoveryBadge(`${data.tokens_found || 0} nouveaux`, 'success');
                showDiscoveryStatus(`✅ ${data.tokens_found || 0} tokens découverts`);
                setTimeout(() => {
                    hideDiscoveryStatus();
                    updateDiscoveryBadge('Connecté', 'success');
                }, 3000);
            });

            // Erreur
            socket.on('scan_error', (data) => {
                console.error('❌ Erreur Discovery:', data.error);
                updateDiscoveryBadge('Erreur', 'error');
                showDiscoveryStatus(`❌ Erreur: ${data.error}`);
            });

            // Déconnexion
            socket.on('disconnect', (reason) => {
                console.log('🔌 Déconnecté Discovery Service:', reason);
                discoveryActive = false;
                updateDiscoveryBadge('Déconnecté', 'error');
            });
        }

        // Charger les tokens existants depuis la BDD
        async function loadExistingTokens() {
            try {
                const response = await fetch('/api/discovery/recent?limit=50');
                const data = await response.json();

                console.log('📡 Discovery API Response:', data);

                if (data.success && data.tokens && data.tokens.length > 0) {
                    console.log(`📦 Chargement de ${data.tokens.length} tokens existants`);
                    console.log('🔍 Premier token:', data.tokens[0]);

                    // Retirer le loading
                    const loadingEl = document.getElementById('discovered-tokens-loading');
                    if (loadingEl) loadingEl.remove();

                    // Afficher chaque token
                    data.tokens.forEach((tokenWrapper, index) => {
                        // Debug du premier token
                        if (index === 0) {
                            console.log('🔍 Token wrapper:', tokenWrapper);
                            console.log('🔍 Token data:', tokenWrapper.token_data);
                        }

                        // Le token_data est déjà parsé par le backend
                        addDiscoveredToken(tokenWrapper.token_data, false);  // false = pas d'animation
                    });
                } else {
                    // Aucun token existant
                    const loadingEl = document.getElementById('discovered-tokens-loading');
                    if (loadingEl) {
                        loadingEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 1rem;">Aucun token découvert pour le moment. Les nouveaux tokens apparaîtront automatiquement toutes les 3 minutes.</p>';
                    }
                }
            } catch (error) {
                console.error('❌ Erreur chargement tokens:', error);
                const loadingEl = document.getElementById('discovered-tokens-loading');
                if (loadingEl) {
                    loadingEl.innerHTML = '<p style="color: var(--accent-danger); font-size: 1rem;">❌ Erreur de chargement. Rechargez la page.</p>';
                }
            }
        }

        // Mettre à jour le badge de statut Discovery
        function updateDiscoveryBadge(text, status) {
            const badgeText = document.getElementById('discovery-badge-text');
            const badge = document.getElementById('discovery-badge');

            if (!badgeText || !badge) return;

            badgeText.textContent = text;

            // Changer la couleur selon le statut
            if (status === 'success') {
                badge.style.background = 'rgba(34, 197, 94, 0.1)';
                badge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                badge.style.color = '#22c55e';
            } else if (status === 'scanning') {
                badge.style.background = 'rgba(102, 126, 234, 0.1)';
                badge.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                badge.style.color = '#667eea';
            } else if (status === 'error') {
                badge.style.background = 'rgba(239, 68, 68, 0.1)';
                badge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                badge.style.color = '#ef4444';
            }
        }

        // Afficher un statut Discovery
        function showDiscoveryStatus(message) {
            let statusEl = document.getElementById('discovery-status');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'discovery-status';
                statusEl.style.cssText = 'position: fixed; top: 80px; right: 20px; background: var(--bg-card); border: 2px solid var(--accent-primary); border-radius: 0.75rem; padding: 1rem 1.5rem; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); z-index: 9999; font-size: 0.9rem; font-weight: 600; color: var(--text-primary);';
                document.body.appendChild(statusEl);
            }
            statusEl.textContent = message;
            statusEl.style.display = 'block';
        }

        function hideDiscoveryStatus() {
            const statusEl = document.getElementById('discovery-status');
            if (statusEl) {
                statusEl.style.display = 'none';
            }
        }

        // Ajouter un token découvert à la grille dynamique (VERSION COMPLÈTE RICHE)
        function addDiscoveredToken(token, animate = true) {
            const grid = document.getElementById('discovered-tokens-grid');
            if (!grid) return;

            console.log('🎨 Adding rich token to grid:', token);

            // Retirer le loading
            const loadingEl = document.getElementById('discovered-tokens-loading');
            if (loadingEl) loadingEl.remove();

            // Extraire les données
            const hasMarketData = token.market && !token.market.error;
            const hasSecurity = token.security && !token.security.error;
            const price = hasMarketData ? token.market.price_usd : 0;
            const change24h = hasMarketData ? (token.market.price_change_24h || 0) : 0;
            const change6h = hasMarketData ? (token.market.price_change_6h || 0) : 0;
            const change1h = hasMarketData ? (token.market.price_change_1h || 0) : 0;
            const liquidity = hasMarketData ? (token.market.liquidity_usd || 0) : 0;
            const volume24h = hasMarketData ? (token.market.volume_24h || 0) : 0;
            const marketCap = hasMarketData ? (token.market.market_cap || 0) : 0;
            const buys = hasMarketData ? (token.market.txns_24h_buys || 0) : 0;
            const sells = hasMarketData ? (token.market.txns_24h_sells || 0) : 0;
            const pairAge = hasMarketData ? token.market.pair_created_at : 'N/A';
            const buyTax = hasSecurity ? (token.security.buy_tax || 0) : 0;
            const sellTax = hasSecurity ? (token.security.sell_tax || 0) : 0;
            const holders = hasSecurity ? (token.security.holder_count || 'N/A') : 'N/A';
            const isHoneypot = hasSecurity ? token.security.is_honeypot : false;
            const riskScore = token.risk_score || 50;
            const riskColor = riskScore < 30 ? '#22c55e' : riskScore < 70 ? '#f59e0b' : '#ef4444';

            // Format helpers
            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                return num.toFixed(2);
            };
            const formatPrice = (p) => {
                if (p >= 1) return '$' + p.toFixed(4);
                if (p >= 0.0001) return '$' + p.toFixed(6);
                return '$' + p.toExponential(2);
            };
            const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';
            const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';

            // Créer carte
            const tokenCard = document.createElement('div');
            tokenCard.style.cssText = `background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; backdrop-filter: blur(20px); transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); cursor: pointer; ${animate ? 'animation: fadeInScale 0.5s ease-out;' : ''}`;

            tokenCard.innerHTML = `
                <div style="display: flex; gap: 0.75rem; align-items: start; margin-bottom: 0.75rem;">
                    <div style="position: relative;">
                        ${token.icon ? `<img src="${token.icon}" alt="${token.name || 'Token'}" style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--bg-glass); padding: 0.25rem;" onerror="this.style.display='none'">` : `<div style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🪙</div>`}
                        <button onclick="event.stopPropagation(); toggleFavorite('${token.address}', '${token.chain}', -1);" id="fav-btn-${token.address}" style="position: absolute; top: -6px; right: -6px; background: rgba(0, 0, 0, 0.7); border: 1px solid var(--border-subtle); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; transition: all 0.2s; z-index: 10; display: flex; align-items: center; justify-content: center; padding: 0;" onmouseenter="this.style.transform='scale(1.15)'; this.style.background='rgba(255, 215, 0, 0.3)'; this.style.borderColor='#ffd700';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(0, 0, 0, 0.7)'; this.style.borderColor='var(--border-subtle)';"><span style="font-size: 0.75rem;">⭐</span></button>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${token.name || token.symbol || 'Unknown'}</h4>
                        <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.4rem;">${token.address ? (token.address.substring(0, 8) + '...' + token.address.substring(token.address.length - 6)) : 'N/A'}</div>
                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                            <span style="padding: 0.15rem 0.5rem; background: rgba(102, 126, 234, 0.1); color: #667eea; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 600;">${token.chain || 'Unknown'}</span>
                            ${token.is_safe ? '<span style="padding: 0.15rem 0.5rem; background: rgba(34, 197, 94, 0.1); color: #22c55e; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 600;">✅ Safe</span>' : '<span style="padding: 0.15rem 0.5rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 600;">⚠️ Risky</span>'}
                            ${token.is_pump_dump_suspect ? '<span style="padding: 0.15rem 0.5rem; background: rgba(245, 158, 11, 0.1); color: #f59e0b; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 600;">🚨 P&D</span>' : ''}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: ${riskColor}; color: white; padding: 0.4rem 0.75rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.875rem; margin-bottom: 0.35rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap;">${riskScore}</div>
                        ${hasMarketData ? `<div style="font-size: 1rem; font-weight: 700; margin-bottom: 0.15rem;">${formatPrice(price)}</div><div style="color: ${colorChange(change24h)}; font-weight: 600; font-size: 0.75rem;">${formatChange(change24h)}</div>` : '<div style="color: var(--text-tertiary); font-size: 0.7rem;">No price</div>'}
                    </div>
                </div>
                ${hasMarketData ? `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💧 Liq</div><div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(liquidity)}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">📊 Vol</div><div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(volume24h)}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💎 MCap</div><div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(marketCap)}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">⏰ Age</div><div style="font-weight: 700; font-size: 0.7rem;">${pairAge !== 'N/A' ? Math.floor((Date.now() - pairAge * 1000) / (1000 * 60 * 60)) + 'h' : 'N/A'}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">1H</div><div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change1h)};">${formatChange(change1h)}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">6H</div><div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change6h)};">${formatChange(change6h)}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🟢 Buys</div><div style="font-weight: 700; font-size: 0.75rem; color: #22c55e;">${buys}</div></div>
                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;"><div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🔴 Sells</div><div style="font-weight: 700; font-size: 0.75rem; color: #ef4444;">${sells}</div></div>
                </div>` : '<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;"><div style="color: #ef4444; font-weight: 600; font-size: 0.75rem; text-align: center;">⚠️ Market data unavailable</div></div>'}
                ${hasSecurity ? `<div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;"><div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase;">🔒 Security</div><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; font-size: 0.7rem;"><div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span style="color: var(--text-tertiary);">Buy Tax:</span><span style="font-weight: 700; color: ${buyTax > 10 ? '#ef4444' : buyTax > 5 ? '#f59e0b' : '#22c55e'};">${buyTax.toFixed(1)}%</span></div><div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span style="color: var(--text-tertiary);">Sell Tax:</span><span style="font-weight: 700; color: ${sellTax > 10 ? '#ef4444' : sellTax > 5 ? '#f59e0b' : '#22c55e'};">${sellTax.toFixed(1)}%</span></div><div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span style="color: var(--text-tertiary);">Honeypot:</span><span style="font-weight: 700; color: ${isHoneypot ? '#ef4444' : '#22c55e'};">${isHoneypot ? '❌' : '✅'}</span></div><div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span style="color: var(--text-tertiary);">Holders:</span><span style="font-weight: 700;">${holders !== 'N/A' ? formatNumber(parseInt(holders)) : 'N/A'}</span></div></div></div>` : ''}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem;">
                    <button onclick="alert('AI Analysis: Feature coming soon!')" style="padding: 0.6rem 0.75rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3); font-size: 0.8rem;"><span>🤖</span><span>AI</span></button>
                    ${token.url ? `<a href="${token.url}" target="_blank" style="padding: 0.6rem 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;"><span>📊</span><span>Dex</span></a>` : ''}
                    ${token.twitter ? `<a href="${token.twitter}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;"><span>🐦</span><span>X</span></a>` : ''}
                    ${token.website ? `<a href="${token.website}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;"><span>🌐</span><span>Web</span></a>` : ''}
                    ${token.telegram ? `<a href="${token.telegram}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(34, 197, 233, 0.1); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;"><span>✈️</span><span>TG</span></a>` : ''}
                    ${token.discord ? `<a href="${token.discord}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;"><span>💬</span><span>DC</span></a>` : ''}
                </div>
            `;

            tokenCard.onmouseenter = () => {tokenCard.style.transform = 'translateY(-2px)'; tokenCard.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.15)'; tokenCard.style.borderColor = 'var(--accent-primary)';};
            tokenCard.onmouseleave = () => {tokenCard.style.transform = 'translateY(0)'; tokenCard.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)'; tokenCard.style.borderColor = 'var(--border-subtle)';};
            tokenCard.onclick = () => showTokenDetailsModal(token);

            grid.insertBefore(tokenCard, grid.firstChild);
        }

        // Initialiser au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            initializeDiscovery();
        });

        // ==================== ANALYSE SPÉCIFIQUE ====================
        /**
         * Analyse un token spécifique par adresse ou URL DexScreener
         * ⚠️ Cette fonction utilise /api/scan/start qui est PRIVÉE et NON partagée
         */
        async function analyzeSpecificToken() {
            const input = document.getElementById('specific-token-input');
            const progressDiv = document.getElementById('specific-token-progress');
            const resultsDiv = document.getElementById('specific-token-results');
            const statusText = document.getElementById('specific-token-status');

            if (!input || !progressDiv || !resultsDiv || !statusText) {
                console.error('❌ Éléments UI manquants');
                return;
            }

            const value = input.value.trim();
            if (!value) {
                alert('⚠️ Veuillez entrer une adresse ou URL DexScreener');
                input.focus();
                return;
            }

            console.log('🔍 Analyse spécifique:', value);

            // Construire l'URL de profil
            let profileUrl = value;
            if (!value.startsWith('http')) {
                // Si c'est juste une adresse, construire l'URL
                // Format: https://dexscreener.com/ethereum/ADDRESS
                profileUrl = `https://dexscreener.com/ethereum/${value}`;
            }

            // Afficher le progress
            resultsDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            statusText.textContent = 'Connexion au scanner...';

            try {
                // Lancer le scan privé
                const scanResponse = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        profile_url: profileUrl,
                        max_tokens: 1,
                        nitter_url: 'http://localhost:8080'  // Nitter local
                    })
                });

                const scanData = await scanResponse.json();

                if (!scanData.success) {
                    throw new Error(scanData.error || 'Échec du scan');
                }

                statusText.textContent = 'Analyse en cours...';

                // Polling pour obtenir les résultats
                const maxAttempts = 60;  // 60 secondes max
                let attempts = 0;
                let scanComplete = false;
                let tokenResult = null;

                while (attempts < maxAttempts && !scanComplete) {
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Vérifier la progression
                    const progressResponse = await fetch('/api/scan/progress');
                    const progressData = await progressResponse.json();

                    if (progressData.status === 'completed') {
                        // Récupérer les résultats
                        const resultsResponse = await fetch('/api/scan/results');
                        const resultsData = await resultsResponse.json();

                        if (resultsData.success && resultsData.results && resultsData.results.length > 0) {
                            tokenResult = resultsData.results[0];
                            scanComplete = true;
                        }
                    } else if (progressData.status === 'error') {
                        throw new Error(progressData.error || 'Erreur pendant le scan');
                    } else if (progressData.status === 'scanning') {
                        statusText.textContent = `Analyse en cours... ${progressData.scanned}/${progressData.total} tokens`;
                    }

                    attempts++;
                }

                if (!scanComplete) {
                    throw new Error('Timeout: Le scan a pris trop de temps');
                }

                // Masquer le progress
                progressDiv.style.display = 'none';

                // Afficher les résultats
                displaySpecificTokenResult(tokenResult);

            } catch (error) {
                console.error('❌ Erreur analyse spécifique:', error);
                progressDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 1rem; padding: 2rem; text-align: center;">
                        <span style="font-size: 3rem;">⚠️</span>
                        <h3 style="margin: 1rem 0 0.5rem 0; color: #ef4444;">Erreur d'analyse</h3>
                        <p style="color: var(--text-secondary); margin: 0;">${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * Affiche le résultat d'une analyse spécifique
         */
        function displaySpecificTokenResult(token) {
            const resultsDiv = document.getElementById('specific-token-results');
            if (!resultsDiv) return;

            resultsDiv.style.display = 'block';

            // Calculer le score global
            const globalScore = calculateGlobalScore(token);

            resultsDiv.innerHTML = `
                <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 2rem; margin-bottom: 1rem;">
                    <!-- En-tête du token -->
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-subtle);">
                        ${token.icon ? `<img src="${token.icon}" alt="${token.symbol}" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">` : '<div style="width: 80px; height: 80px; border-radius: 50%; background: var(--gradient-primary);"></div>'}
                        <div style="flex: 1;">
                            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">${token.name || 'Unknown Token'}</h2>
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <span style="font-size: 1.1rem; color: var(--text-secondary); font-weight: 600;">${token.symbol || '?'}</span>
                                <span style="padding: 0.35rem 1rem; background: rgba(102, 126, 234, 0.1); color: #667eea; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">${token.chain || 'Unknown'}</span>
                                ${token.is_safe ? '<span style="padding: 0.35rem 1rem; background: rgba(34, 197, 94, 0.1); color: #22c55e; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">✅ Safe</span>' : '<span style="padding: 0.35rem 1rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">⚠️ Risky</span>'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2.5rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${globalScore}/100</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Score Global</div>
                        </div>
                    </div>

                    <!-- Stats principales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        ${token.price ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                            <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">💰 Prix</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">$${parseFloat(token.price).toFixed(8)}</div>
                        </div>
                        ` : ''}
                        ${token.market_cap ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                            <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">📊 Market Cap</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">$${formatNumber(token.market_cap)}</div>
                        </div>
                        ` : ''}
                        ${token.liquidity ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                            <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">💧 Liquidité</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">$${formatNumber(token.liquidity)}</div>
                        </div>
                        ` : ''}
                        ${token.volume_24h ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                            <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">📈 Volume 24h</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">$${formatNumber(token.volume_24h)}</div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Analysis détaillée -->
                    ${token.analysis ? `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">🤖 Analyse Claude AI</h3>
                        <div style="color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;">${token.analysis}</div>
                    </div>
                    ` : ''}

                    <!-- Liens -->
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        ${token.url ? `<a href="${token.url}" target="_blank" style="padding: 0.75rem 1.5rem; background: var(--gradient-primary); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; transition: all 0.2s;">🔗 DexScreener</a>` : ''}
                        ${token.address ? `<button onclick="copyToClipboard('${token.address}')" style="padding: 0.75rem 1.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; color: var(--text-primary); cursor: pointer; font-weight: 600; transition: all 0.2s;">📋 Copier l'adresse</button>` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Voir les détails d'un token découvert
         * Utilisé depuis les cartes de tokens dans la grille dynamique
         */
        async function viewTokenDetails(address, chain) {
            console.log('👁️ Affichage détails:', address, chain);

            // Scroller vers la section de recherche spécifique
            const specificSection = document.getElementById('specific-token-results');
            if (specificSection) {
                specificSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Pré-remplir l'input avec l'adresse
            const input = document.getElementById('specific-token-input');
            if (input) {
                input.value = address;
            }

            // Lancer l'analyse
            await analyzeSpecificToken();
        }

        /**
         * Copier dans le presse-papier
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('✅ Copié dans le presse-papier:', text);
                // Afficher une notification temporaire
                const notification = document.createElement('div');
                notification.textContent = '✅ Adresse copiée !';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(34, 197, 94, 0.9);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 0.5rem;
                    font-weight: 600;
                    z-index: 10000;
                    animation: fadeInOut 2s ease-in-out;
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            }).catch(err => {
                console.error('❌ Erreur copie:', err);
                alert('Erreur lors de la copie');
            });
        }

        /**
         * Calculer le score global d'un token
         */
        function calculateGlobalScore(token) {
            let score = 50;  // Score de base

            // Sécurité (+30 points)
            if (token.is_safe) score += 30;

            // Liquidité (+10 points si > 50k)
            if (token.liquidity && parseFloat(token.liquidity) > 50000) score += 10;

            // Volume (+10 points si > 10k)
            if (token.volume_24h && parseFloat(token.volume_24h) > 10000) score += 10;

            // Market cap présent (+5 points)
            if (token.market_cap) score += 5;

            // Holders (+5 points si présent)
            if (token.holders) score += 5;

            return Math.min(100, score);
        }

        /**
         * Formater les grands nombres
         */
        function formatNumber(num) {
            const n = parseFloat(num);
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(2);
        }

        // ==================== USER INFO ====================
        // Load user info and update welcome
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();

                if (data.authenticated && data.user) {
                    const user = data.user;
                    document.getElementById('welcome-name').textContent = user.username;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Scroll to search bar
        function scrollToScanner() {
            // Scroller vers la barre de recherche en haut
            const searchBar = document.getElementById('tokenSearchInput');
            if (searchBar) {
                searchBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                searchBar.focus();
            }
        }

        // Toggle favorite
        async function toggleFavorite(address, chain, tokenIndex) {
            const tokenData = window.currentTokens[tokenIndex];
            if (!tokenData) {
                console.error('Token not found');
                return;
            }

            const btn = document.getElementById(`fav-btn-${address}`);

            try {
                // Check if already favorited
                const checkResponse = await fetch('/api/favorites');
                const checkData = await checkResponse.json();

                const isFavorited = checkData.success && checkData.favorites.some(fav =>
                    fav.token_address === address && fav.chain === chain
                );

                if (isFavorited) {
                    // Remove from favorites
                    const response = await fetch('/api/favorites/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token_address: address, chain: chain })
                    });

                    const data = await response.json();
                    if (data.success) {
                        btn.innerHTML = '<span style="font-size: 1.25rem;">⭐</span>';
                        btn.style.background = 'rgba(0, 0, 0, 0.5)';
                        console.log('✅ Retiré des favoris');
                    }
                } else {
                    // Add to favorites
                    const response = await fetch('/api/favorites/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token_address: address,
                            chain: chain,
                            token_data: tokenData
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        btn.innerHTML = '<span style="font-size: 1.25rem;">⭐</span>';
                        btn.style.background = 'rgba(255, 215, 0, 0.3)';
                        btn.style.borderColor = '#ffd700';
                        console.log('✅ Ajouté aux favoris');
                    }
                }

                // Refresh favorites count
                await loadFavoritesCount();
            } catch (error) {
                console.error('Erreur favoris:', error);
            }
        }

        // Refresh token price from Moralis API
        async function refreshTokenPrice(address, chain, tokenIndex) {
            const priceDiv = document.getElementById(`price-${address}`);
            const changeDiv = document.getElementById(`change-${address}`);
            const refreshBtn = document.getElementById(`refresh-btn-${address}`);
            const refreshIcon = document.getElementById(`refresh-icon-${address}`);

            if (!priceDiv || !changeDiv || !refreshBtn) {
                console.error('Price elements not found for', address);
                return;
            }

            try {
                // Animate button - spin animation
                refreshIcon.style.display = 'inline-block';
                refreshIcon.style.animation = 'spin 1s linear infinite';
                refreshBtn.disabled = true;
                refreshBtn.style.opacity = '0.7';

                console.log(`💰 Refreshing price for ${address.substring(0, 10)}... on ${chain}`);

                // Call Moralis API
                const response = await fetch(`/api/token/price?address=${address}&chain=${chain}`);
                const data = await response.json();

                if (data.success && data.usd_price !== null && data.usd_price !== undefined) {
                    const newPrice = data.usd_price;
                    const priceChange24h = data.usd_price_24h_change_percent || 0;

                    // Format price
                    const formatPrice = (p) => {
                        if (p >= 1) return '$' + p.toFixed(4);
                        if (p >= 0.0001) return '$' + p.toFixed(6);
                        return '$' + p.toExponential(2);
                    };

                    const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
                    const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';

                    // Animate price update with flash effect
                    priceDiv.style.transition = 'all 0.3s ease';
                    changeDiv.style.transition = 'all 0.3s ease';

                    // Flash effect
                    priceDiv.style.background = 'rgba(102, 126, 234, 0.3)';
                    changeDiv.style.background = 'rgba(102, 126, 234, 0.3)';

                    setTimeout(() => {
                        // Update values
                        priceDiv.textContent = formatPrice(newPrice);
                        changeDiv.textContent = formatChange(priceChange24h);
                        changeDiv.style.color = colorChange(priceChange24h);

                        // Update token data in global array
                        if (window.currentTokens && window.currentTokens[tokenIndex]) {
                            if (!window.currentTokens[tokenIndex].market) {
                                window.currentTokens[tokenIndex].market = {};
                            }
                            window.currentTokens[tokenIndex].market.price_usd = newPrice;
                            window.currentTokens[tokenIndex].market.price_change_24h = priceChange24h;
                        }

                        // Remove flash after animation
                        setTimeout(() => {
                            priceDiv.style.background = 'transparent';
                            changeDiv.style.background = 'transparent';
                        }, 300);
                    }, 100);

                    console.log(`✅ Prix mis à jour: ${formatPrice(newPrice)} (${formatChange(priceChange24h)})`);
                } else {
                    console.warn('⚠️ Pas de prix disponible:', data);
                    // Show error briefly
                    refreshIcon.textContent = '❌';
                    setTimeout(() => {
                        refreshIcon.textContent = '🔄';
                    }, 2000);
                }

            } catch (error) {
                console.error('❌ Error refreshing price:', error);
                // Show error briefly
                refreshIcon.textContent = '❌';
                setTimeout(() => {
                    refreshIcon.textContent = '🔄';
                }, 2000);
            } finally {
                // Stop animation
                refreshIcon.style.animation = '';
                refreshBtn.disabled = false;
                refreshBtn.style.opacity = '1';
            }
        }

        // Start scan
        async function startScan() {
            // Reset auto-scan countdown to 5 minutes when manual scan starts
            if (typeof secondsRemaining !== 'undefined') {
                secondsRemaining = 300;
                updateCountdown();
            }

            const maxTokens = parseInt(document.getElementById('max-tokens').value);

            const btn = document.getElementById('start-scan-btn');
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 1.25rem;">⏳</span><span>Scan en cours...</span>';

            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-results').style.display = 'none';

            try {
                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        max_tokens: maxTokens
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Poll for results
                    pollScanResults();
                } else {
                    alert('Erreur: ' + (data.error || 'Échec du scan'));
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                alert('Erreur réseau');
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                document.getElementById('scan-progress').style.display = 'none';
            }
        }

        // Poll scan results
        async function pollScanResults() {
            try {
                const response = await fetch('/api/scan/progress');
                const data = await response.json();

                if (data.in_progress) {
                    document.getElementById('scan-status').textContent = data.message || 'Analyse en cours...';
                    setTimeout(pollScanResults, 2000);
                } else {
                    // Scan complete
                    const resultsResponse = await fetch('/api/scan/results');
                    const resultsData = await resultsResponse.json();

                    displayScanResults(resultsData);

                    const btn = document.getElementById('start-scan-btn');
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Error polling:', error);
                setTimeout(pollScanResults, 2000);
            }
        }

        // Load tokens from database on page load (LEGACY - redirects to new system)
        async function loadTokensFromDatabase() {
            console.log('🔄 loadTokensFromDatabase() called (redirecting to loadExistingTokens)...');
            // Redirect to new Discovery system
            await loadExistingTokens();
        }

        // Store current tokens globally for AI analysis
        window.currentTokens = [];

        // Update favorite buttons to show current state
        async function updateFavoriteButtons() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();

                if (data.success && data.favorites) {
                    data.favorites.forEach(fav => {
                        const btn = document.getElementById(`fav-btn-${fav.token_address}`);
                        if (btn) {
                            btn.style.background = 'rgba(255, 215, 0, 0.3)';
                            btn.style.borderColor = '#ffd700';
                        }
                    });
                }
            } catch (error) {
                console.log('Error loading favorites state:', error);
            }
        }

        // Open token details modal
        function openTokenDetails(tokenIndex) {
            const token = window.currentTokens[tokenIndex];
            if (!token) {
                console.error('Token not found at index:', tokenIndex);
                return;
            }

            const hasMarketData = token.market && !token.market.error;
            const hasSecurity = token.security && !token.security.error;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'token-details-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem; backdrop-filter: blur(10px);';

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 1rem; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
                    <!-- Close button -->
                    <button onclick="document.getElementById('token-details-modal').remove()" style="position: absolute; top: 1rem; right: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem; color: var(--text-secondary); transition: all 0.2s;" onmouseenter="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.borderColor='#ef4444'; this.style.color='#ef4444';" onmouseleave="this.style.background='var(--bg-glass)'; this.style.borderColor='var(--border-subtle)'; this.style.color='var(--text-secondary)';">✕</button>

                    <!-- Header -->
                    <div style="display: flex; gap: 1.5rem; align-items: start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-subtle);">
                        ${token.icon ? `<img src="${token.icon}" style="width: 80px; height: 80px; border-radius: 1rem;">` : '<div style="width: 80px; height: 80px; border-radius: 1rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">🪙</div>'}
                        <div style="flex: 1;">
                            <h2 style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.5rem;">${token.description || 'Token Details'}</h2>
                            <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem;">${token.address}</div>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                ${createChainBadge(token.chain, 'large')}
                                ${createSafetyBadge(token.is_safe, 'large')}
                                ${createRiskScoreBadge(token.risk_score, 'large')}
                            </div>
                        </div>
                    </div>

                    <!-- Full Details Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        ${hasMarketData ? createMarketDataCard(token.market) : ''}
                        ${hasSecurity ? createSecurityCard(token.security) : ''}

                        ${token.pump_dump_score ? `
                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">🚨 Pump & Dump Risk</h3>
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 3rem; font-weight: 800; background: var(--gradient-danger); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${token.pump_dump_score}/100</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: ${token.pump_dump_risk === 'FAIBLE' ? '#22c55e' : token.pump_dump_risk === 'MOYEN' ? '#f59e0b' : '#ef4444'};">${token.pump_dump_risk}</div>
                                </div>
                                ${token.pump_dump_warnings && token.pump_dump_warnings.length > 0 ? `
                                    <div style="background: rgba(239, 68, 68, 0.1); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.8rem; line-height: 1.5;">
                                        ${token.pump_dump_warnings.slice(0, 5).map(w => `<div style="margin-bottom: 0.5rem;">• ${w}</div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${token.creator_security?.is_malicious ? `
                            <div style="background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.05) 100%); border: 2px solid #dc2626; border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: #dc2626; margin-bottom: 1rem; text-transform: uppercase;">💀 CRÉATEUR BLACKLISTÉ</h3>
                                <div style="background: rgba(220, 38, 38, 0.2); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                                    <div style="font-weight: 700; font-size: 1rem; color: #dc2626; margin-bottom: 0.5rem;">⚠️ SCAMMER RÉCIDIVISTE DÉTECTÉ</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Ce token a été créé par une adresse connue pour des activités frauduleuses.</div>
                                    ${token.creator_address ? `<div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); word-break: break-all;">Créateur: ${token.creator_address}</div>` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.8rem;">
                                    ${token.creator_security.malicious_address_type ? `<div>Type: <span style="font-weight: 700; color: #dc2626;">${token.creator_security.malicious_address_type}</span></div>` : ''}
                                    ${token.creator_security.phishing_activities ? `<div>🎣 Phishing: <span style="font-weight: 700;">${token.creator_security.phishing_activities} activités</span></div>` : ''}
                                    ${token.creator_security.honeypot_related_address ? `<div>🍯 Lié à des honeypots</div>` : ''}
                                    ${token.creator_security.darkweb_transactions ? `<div>🕵️ Transactions darkweb</div>` : ''}
                                    ${token.creator_security.stealing_attack ? `<div>💰 Attaques de vol détectées</div>` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${token.rugpull_detection?.is_rugpull_risk ? `
                            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%); border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem; text-transform: uppercase;">🎣 RISQUE RUG-PULL</h3>
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${token.rugpull_detection.rugpull_risk_level?.toUpperCase() || 'DÉTECTÉ'}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Patterns suspects dans le smart contract</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.8rem;">
                                    ${token.rugpull_detection.liquidity_removable ? `<div style="color: #ef4444;">💧 Liquidité peut être retirée</div>` : ''}
                                    ${!token.rugpull_detection.ownership_renounced ? `<div style="color: #f59e0b;">👤 Ownership non renoncé</div>` : ''}
                                    ${token.rugpull_detection.transfer_pausable ? `<div style="color: #f59e0b;">⏸️ Transfers peuvent être pausés</div>` : ''}
                                    ${token.rugpull_detection.can_take_back_ownership ? `<div style="color: #ef4444;">🔄 Owner peut reprendre le contrôle</div>` : ''}
                                    ${token.rugpull_detection.hidden_owner ? `<div style="color: #ef4444;">🕵️ Owner caché détecté</div>` : ''}
                                    ${token.rugpull_detection.slippage_modifiable ? `<div style="color: #f59e0b;">📊 Slippage modifiable</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- All Warnings -->
                    ${token.warnings && token.warnings.length > 0 ? `
                        <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 0.875rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem; text-transform: uppercase;">⚠️ All Warnings</h3>
                            <div style="display: grid; gap: 0.5rem; font-size: 0.875rem; line-height: 1.6;">
                                ${token.warnings.map(w => `<div>• ${w}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Top Holders Section (Modal Full List) -->
                    ${hasSecurity && token.security.holders && token.security.holders.length > 0 ? `
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 0.875rem; font-weight: 700; color: #8b5cf6; margin-bottom: 1.5rem; text-transform: uppercase; display: flex; align-items: center; gap: 0.5rem;">
                                👥 Top ${token.security.holders.length} Holder${token.security.holders.length === 1 ? '' : 's'} Distribution
                                <span style="font-size: 0.75rem; font-weight: 600; background: rgba(139, 92, 246, 0.2); padding: 0.25rem 0.75rem; border-radius: 1rem;">${token.security.holder_count || 'N/A'} Total</span>
                            </h3>
                            <div style="display: grid; gap: 0.75rem;">
                                ${token.security.holders.map((holder, idx) => {
                                    const percent = parseFloat(holder.percent || 0);
                                    const barColor = percent > 20 ? '#ef4444' : percent > 10 ? '#f59e0b' : '#8b5cf6';
                                    const tag = holder.tag || (holder.is_locked ? '🔒 Locked' : holder.is_contract ? '📝 Contract' : '');
                                    const isHighRisk = percent > 20;
                                    return `
                                        <div style="background: ${isHighRisk ? 'rgba(239, 68, 68, 0.05)' : 'var(--bg-card)'}; border: 1px solid ${isHighRisk ? 'rgba(239, 68, 68, 0.2)' : 'var(--border-subtle)'}; border-radius: 0.5rem; padding: 1rem;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-weight: 700; color: ${barColor}; font-size: 1rem;">#${idx + 1}</span>
                                                    <span style="font-family: monospace; font-size: 0.85rem; color: var(--text-secondary);">
                                                        ${holder.address.substring(0, 10)}...${holder.address.substring(holder.address.length - 8)}
                                                    </span>
                                                    ${tag ? `<span style="background: ${barColor}22; color: ${barColor}; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 600;">${tag}</span>` : ''}
                                                    ${isHighRisk ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.7rem; font-weight: 700;">⚠️ HIGH</span>' : ''}
                                                </div>
                                                <span style="font-weight: 800; font-size: 1.1rem; color: ${barColor};">${percent.toFixed(2)}%</span>
                                            </div>
                                            <div style="width: 100%; height: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                                                <div style="width: ${Math.min(percent, 100)}%; height: 100%; background: linear-gradient(90deg, ${barColor} 0%, ${barColor}dd 100%); transition: width 0.5s ease-out; box-shadow: 0 0 10px ${barColor}66;"></div>
                                            </div>
                                            ${holder.balance ? `<div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-tertiary);">Balance: ${parseFloat(holder.balance).toLocaleString('en-US', {maximumFractionDigits: 2})} tokens</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${token.security.creator_percent && parseFloat(token.security.creator_percent) > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.5rem;">
                                    <div style="font-size: 0.8rem; color: #f59e0b; font-weight: 600;">
                                        ⚠️ Creator holds ${parseFloat(token.security.creator_percent).toFixed(2)}% of supply
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : hasSecurity && token.security.data_warning === 'solana_beta_limited_data' ? `
                        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(168, 85, 247, 0.03) 100%); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">👥</div>
                            <h3 style="font-size: 0.875rem; font-weight: 700; color: #a855f7; margin-bottom: 0.75rem; text-transform: uppercase;">
                                Holder Data Not Available
                            </h3>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6; max-width: 400px; margin: 0 auto;">
                                GoPlus Solana API is currently in Beta. Holder distribution data may be limited or unavailable for some tokens.
                            </p>
                        </div>
                    ` : ''}

                    <!-- 📊 TECHNICAL ANALYSIS SECTION (For Established Tokens) -->
                    ${token.technical_analysis ? `
                        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.25rem; font-weight: 800; color: var(--accent-primary); text-transform: uppercase; display: flex; align-items: center; gap: 0.75rem; margin: 0;">
                                    📊 Technical Analysis
                                    <span style="background: rgba(102, 126, 234, 0.2); padding: 0.35rem 0.75rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600;">
                                        ${token.technical_analysis.token_age_hours ? Math.floor(token.technical_analysis.token_age_hours / 24) + ' days old' : 'Established'}
                                    </span>
                                </h3>
                                ${createTradingSignalBadge(token.technical_analysis.trading_signal, 'large')}
                            </div>

                            <!-- RSI Gauge -->
                            ${createRSIGauge(token.technical_analysis.rsi)}

                            <!-- Key Indicators Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                ${token.technical_analysis.macd ? `
                                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 600;">📉 MACD</div>
                                        <div style="font-size: 1.25rem; font-weight: 800; color: ${token.technical_analysis.macd.trend === 'bullish' ? '#22c55e' : '#ef4444'}; margin-bottom: 0.25rem;">
                                            ${token.technical_analysis.macd.trend === 'bullish' ? '↗️ BULLISH' : '↘️ BEARISH'}
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--text-tertiary);">
                                            Histogram: ${token.technical_analysis.macd.histogram > 0 ? '+' : ''}${token.technical_analysis.macd.histogram.toFixed(6)}
                                        </div>
                                    </div>
                                ` : ''}

                                ${token.technical_analysis.bollinger_bands ? `
                                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 600;">📊 Bollinger Bands</div>
                                        <div style="font-size: 0.9rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                                            Position: ${token.technical_analysis.bollinger_bands.position === 'above_upper' ? '🔴 Above Upper' :
                                                       token.technical_analysis.bollinger_bands.position === 'below_lower' ? '🟢 Below Lower' :
                                                       '⚪ Within Bands'}
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--text-tertiary);">
                                            Bandwidth: ${token.technical_analysis.bollinger_bands.bandwidth.toFixed(2)}%
                                        </div>
                                    </div>
                                ` : ''}

                                ${token.technical_analysis.trend ? `
                                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 600;">📈 Trend</div>
                                        <div style="font-size: 0.9rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                                            ${token.technical_analysis.trend.trend.replace('_', ' ').toUpperCase()}
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--text-tertiary);">
                                            Strength: ${(token.technical_analysis.trend.strength * 100).toFixed(0)}%
                                        </div>
                                    </div>
                                ` : ''}

                                ${token.technical_analysis.emas?.emas ? `
                                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 600;">📊 EMAs</div>
                                        ${token.technical_analysis.emas.signals?.golden_cross ?
                                            '<div style="font-size: 0.9rem; font-weight: 700; color: #22c55e; margin-bottom: 0.25rem;">✨ Golden Cross</div>' :
                                            token.technical_analysis.emas.signals?.death_cross ?
                                            '<div style="font-size: 0.9rem; font-weight: 700; color: #ef4444; margin-bottom: 0.25rem;">💀 Death Cross</div>' :
                                            '<div style="font-size: 0.9rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">No Cross</div>'}
                                        <div style="font-size: 0.7rem; color: var(--text-tertiary);">
                                            EMA 50: $${token.technical_analysis.emas.emas.ema_50?.toFixed(8) || 'N/A'}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Support/Resistance Levels -->
                            ${createSupportResistance(token.technical_analysis.support_resistance)}

                            <!-- Fibonacci Levels -->
                            ${token.technical_analysis.fibonacci ? `
                                <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.5rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">🌀 Fibonacci Retracement & Extensions</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                                        ${Object.entries(token.technical_analysis.fibonacci).filter(([k, v]) => k.startsWith('fib_')).map(([key, value]) => {
                                            const level = key.replace('fib_', '').replace('_', '.');
                                            const isExtension = parseFloat(level) > 100;
                                            const color = isExtension ? '#8b5cf6' : '#667eea';
                                            return `
                                                <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                                    <div style="font-size: 0.7rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${isExtension ? '📈' : '📉'} ${level}%</div>
                                                    <div style="font-family: monospace; font-weight: 700; font-size: 0.8rem; color: ${color};">$${value.toFixed(8)}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; font-size: 0.75rem; color: var(--text-secondary); text-align: center;">
                                        💡 Extensions (>100%) are potential price targets in uptrend
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Trading Recommendation -->
                            ${token.technical_analysis.trading_signal ? `
                                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 0.75rem; padding: 1.5rem; margin-top: 1.5rem;">
                                    <h4 style="font-size: 0.9rem; font-weight: 700; color: var(--accent-primary); margin-bottom: 1rem;">💡 Analysis Summary</h4>
                                    <div style="font-size: 0.9rem; line-height: 1.8; color: var(--text-secondary); margin-bottom: 1rem;">
                                        ${token.technical_analysis.trading_signal.recommendation}
                                    </div>
                                    ${token.technical_analysis.trading_signal.signals?.length > 0 ? `
                                        <div style="background: var(--bg-card); border-radius: 0.5rem; padding: 1rem;">
                                            <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-tertiary); margin-bottom: 0.75rem;">📋 Signals Detected:</div>
                                            ${token.technical_analysis.trading_signal.signals.map(sig => `
                                                <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-secondary); border-radius: 0.35rem; font-size: 0.8rem; color: var(--text-secondary);">
                                                    • ${sig}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : token.analysis_type === 'established_token_analysis' ? `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">📊</div>
                            <h4 style="font-size: 0.95rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">
                                Technical Analysis Unavailable
                            </h4>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; max-width: 500px; margin: 0 auto;">
                                This token qualifies for technical analysis, but OHLCV data could not be fetched. Configure <strong>BIRDEYE_API_KEY</strong> in .env for full TA features.
                            </p>
                        </div>
                    ` : ''}

                    <!-- Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <button onclick="analyzeTokenWithAI(${tokenIndex}, this); event.stopPropagation();" style="padding: 1rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            🤖 Analyze with AI
                        </button>
                        ${token.url ? `<a href="${token.url}" target="_blank" style="padding: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">📊 DexScreener</a>` : ''}
                        ${token.website ? `<a href="${token.website}" target="_blank" style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">🌐 Website</a>` : ''}
                        ${token.twitter ? `<a href="${token.twitter}" target="_blank" style="padding: 1rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">🐦 Twitter</a>` : ''}
                        ${token.telegram ? `<a href="${token.telegram}" target="_blank" style="padding: 1rem; background: rgba(34, 197, 233, 0.1); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">✈️ Telegram</a>` : ''}
                        ${token.discord ? `<a href="${token.discord}" target="_blank" style="padding: 1rem; background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">💬 Discord</a>` : ''}
                    </div>
                </div>
            `;

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Display scan results - ENHANCED WITH ALL AVAILABLE DATA
        function displayScanResults(data) {
            const container = document.getElementById('scan-results');
            container.style.display = 'block';

            console.log('📊 Displaying scan results:', data);

            if (data.results && data.results.length > 0) {
                // Store tokens globally
                window.currentTokens = data.results;

                // Build enriched tokens list
                const tokensHTML = data.results.map((token, index) => {
                    const hasMarketData = token.market && !token.market.error;
                    const hasSecurity = token.security && !token.security.error;
                    const hasTwitter = token.twitter_data && !token.twitter_data.error;

                    // Price & changes
                    const price = hasMarketData ? token.market.price_usd : 0;
                    const change24h = hasMarketData ? (token.market.price_change_24h || 0) : 0;
                    const change6h = hasMarketData ? (token.market.price_change_6h || 0) : 0;
                    const change1h = hasMarketData ? (token.market.price_change_1h || 0) : 0;

                    // Market data
                    const liquidity = hasMarketData ? (token.market.liquidity_usd || 0) : 0;
                    const volume24h = hasMarketData ? (token.market.volume_24h || 0) : 0;
                    const volume6h = hasMarketData ? (token.market.volume_6h || 0) : 0;
                    const marketCap = hasMarketData ? (token.market.market_cap || 0) : 0;
                    const buys = hasMarketData ? (token.market.txns_24h_buys || 0) : 0;
                    const sells = hasMarketData ? (token.market.txns_24h_sells || 0) : 0;
                    const pairAge = hasMarketData ? token.market.pair_created_at : 'N/A';

                    // Security data
                    const buyTax = hasSecurity ? (token.security.buy_tax || 0) : 0;
                    const sellTax = hasSecurity ? (token.security.sell_tax || 0) : 0;
                    const holders = hasSecurity ? (token.security.holder_count || 'N/A') : 'N/A';
                    const isHoneypot = hasSecurity ? token.security.is_honeypot : false;
                    const isMintable = hasSecurity ? token.security.is_mintable : false;
                    const isOpenSource = hasSecurity ? token.security.is_open_source : false;

                    // Social data
                    const socialScore = token.social_score || 0;
                    const followers = hasTwitter ? (token.twitter_data.followers || 0) : 0;
                    const tweets = hasTwitter ? (token.twitter_data.tweets || 0) : 0;

                    // Pump & Dump data
                    const pumpScore = token.pump_dump_score || 0;
                    const pumpRisk = token.pump_dump_risk || 'UNKNOWN';

                    // Risk score color
                    const riskColor = token.risk_score < 30 ? '#22c55e' :
                                     token.risk_score < 70 ? '#f59e0b' : '#ef4444';
                    const pumpColor = pumpRisk === 'FAIBLE' ? '#22c55e' :
                                      pumpRisk === 'MOYEN' ? '#f59e0b' : '#ef4444';

                    // Format numbers
                    const formatNumber = (num) => {
                        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                        return num.toFixed(2);
                    };

                    const formatPrice = (p) => {
                        if (p >= 1) return '$' + p.toFixed(4);
                        if (p >= 0.0001) return '$' + p.toFixed(6);
                        return '$' + p.toExponential(2);
                    };

                    const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';
                    const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';

                    return `
                        <div onclick="openTokenDetails(${index})" style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; backdrop-filter: blur(20px); transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; cursor: pointer;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.15)'; this.style.borderColor='var(--accent-primary)';" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'; this.style.borderColor='var(--border-subtle)';">

                            <!-- Compact Header -->
                            <div style="display: flex; gap: 0.75rem; align-items: start; margin-bottom: 0.75rem;">
                                <!-- Icon + Favorite -->
                                <div style="position: relative;">
                                    ${token.icon ? `
                                        <img src="${token.icon}" alt="${token.description || 'Token'}" style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--bg-glass); padding: 0.25rem;" onerror="this.style.display='none'">
                                    ` : `
                                        <div style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🪙</div>
                                    `}
                                    <button onclick="event.stopPropagation(); toggleFavorite('${token.address}', '${token.chain}', ${index});" id="fav-btn-${token.address}" style="position: absolute; top: -6px; right: -6px; background: rgba(0, 0, 0, 0.7); border: 1px solid var(--border-subtle); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; transition: all 0.2s; z-index: 10; display: flex; align-items: center; justify-content: center; padding: 0;" onmouseenter="this.style.transform='scale(1.15)'; this.style.background='rgba(255, 215, 0, 0.3)'; this.style.borderColor='#ffd700';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(0, 0, 0, 0.7)'; this.style.borderColor='var(--border-subtle)';">
                                        <span style="font-size: 0.75rem;">⭐</span>
                                    </button>
                                </div>

                                <!-- Title + Badges -->
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${token.description || 'Token ' + (index + 1)}
                                    </h4>
                                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.4rem;">
                                        ${token.address.substring(0, 8)}...${token.address.substring(token.address.length - 6)}
                                    </div>
                                    <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                        ${createAllBadges(token)}
                                    </div>
                                </div>

                                <!-- Risk Score + Price -->
                                <div style="text-align: right;">
                                    <div style="background: ${riskColor}; color: white; padding: 0.4rem 0.75rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.875rem; margin-bottom: 0.35rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap;">
                                        ${token.risk_score}
                                    </div>
                                    ${hasMarketData ? `
                                        <div id="price-${token.address}" style="font-size: 1rem; font-weight: 700; margin-bottom: 0.15rem;">
                                            ${formatPrice(price)}
                                        </div>
                                        <div id="change-${token.address}" style="color: ${colorChange(change24h)}; font-weight: 600; font-size: 0.75rem; margin-bottom: 0.5rem;">
                                            ${formatChange(change24h)}
                                        </div>
                                        <button onclick="event.stopPropagation(); refreshTokenPrice('${token.address}', '${token.chain}', ${index});" id="refresh-btn-${token.address}" style="background: var(--gradient-primary); border: none; border-radius: 0.5rem; padding: 0.35rem 0.6rem; font-size: 0.7rem; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); display: flex; align-items: center; gap: 0.25rem; margin: 0 auto;" onmouseenter="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)';" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                                            <span id="refresh-icon-${token.address}">🔄</span>
                                            <span>Prix</span>
                                        </button>
                                    ` : '<div style="color: var(--text-tertiary); font-size: 0.7rem;">No data</div>'}
                                </div>
                            </div>

                            <!-- Quick Stats (2x4 Grid) -->
                            ${hasMarketData ? `
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💧 Liq</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(liquidity)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">📊 Vol</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(volume24h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💎 MCap</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(marketCap)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">⏰ Age</div>
                                        <div style="font-weight: 700; font-size: 0.7rem;">${pairAge !== 'N/A' ? Math.floor((Date.now() - pairAge * 1000) / (1000 * 60 * 60)) + 'h' : 'N/A'}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">1H</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change1h)};">${formatChange(change1h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">6H</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change6h)};">${formatChange(change6h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🟢 Buys</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: #22c55e;">${buys}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🔴 Sells</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: #ef4444;">${sells}</div>
                                    </div>
                                </div>
                            ` : `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="color: #ef4444; font-weight: 600; font-size: 0.75rem; text-align: center;">
                                        ⚠️ Market data unavailable
                                    </div>
                                </div>
                            `}

                            <!-- Enhanced Security Info Grid -->
                            ${hasSecurity ? `
                                <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase;">🔒 Security Details</div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; font-size: 0.7rem;">
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Buy Tax:</span>
                                            <span style="font-weight: 700; color: ${buyTax > 10 ? '#ef4444' : buyTax > 5 ? '#f59e0b' : '#22c55e'};">${buyTax.toFixed(1)}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Sell Tax:</span>
                                            <span style="font-weight: 700; color: ${sellTax > 10 ? '#ef4444' : sellTax > 5 ? '#f59e0b' : '#22c55e'};">${sellTax.toFixed(1)}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Honeypot:</span>
                                            <span style="font-weight: 700; color: ${isHoneypot ? '#ef4444' : '#22c55e'};">${isHoneypot ? '❌ YES' : '✅ NO'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Holders:</span>
                                            <span style="font-weight: 700;">${holders !== 'N/A' ? formatNumber(parseInt(holders)) : 'N/A'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Open Source:</span>
                                            <span style="font-weight: 700; color: ${isOpenSource ? '#22c55e' : '#f59e0b'};">${isOpenSource ? '✅' : '⚠️'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                            <span style="color: var(--text-tertiary);">Mintable:</span>
                                            <span style="font-weight: 700; color: ${isMintable ? '#ef4444' : '#22c55e'};">${isMintable ? '❌ YES' : '✅ NO'}</span>
                                        </div>
                                    </div>
                                    ${(token.security.creator_address || token.creator_address) && (token.security.creator_address !== '0x0000000000000000000000000000000000000000') ? `
                                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle);">
                                            <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">👤 Creator:</div>
                                            <div style="font-family: monospace; font-size: 0.65rem; color: var(--text-secondary); word-break: break-all;">
                                                ${(token.security.creator_address || token.creator_address).substring(0, 16)}...${(token.security.creator_address || token.creator_address).substring((token.security.creator_address || token.creator_address).length - 10)}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${(token.security.owner_address) && (token.security.owner_address !== '0x0000000000000000000000000000000000000000') && (token.security.owner_address !== token.security.creator_address) ? `
                                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle);">
                                            <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">🔑 Owner:</div>
                                            <div style="font-family: monospace; font-size: 0.65rem; color: var(--text-secondary); word-break: break-all;">
                                                ${token.security.owner_address.substring(0, 16)}...${token.security.owner_address.substring(token.security.owner_address.length - 10)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <!-- Top Holders Section -->
                            ${hasSecurity && token.security.holders && token.security.holders.length > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.75rem; color: #8b5cf6; margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase;">
                                        👥 Top ${Math.min(10, token.security.holders.length)} Holder${token.security.holders.length === 1 ? '' : 's'}
                                        ${token.security.holders.length > 10 ? ` <span style="font-size: 0.65rem; font-weight: 600; color: var(--text-tertiary);">(${token.security.holders.length} total)</span>` : ''}
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                                        ${token.security.holders.slice(0, 10).map((holder, idx) => {
                                            const percent = parseFloat(holder.percent || 0);
                                            const barColor = percent > 20 ? '#ef4444' : percent > 10 ? '#f59e0b' : '#8b5cf6';
                                            const tag = holder.tag || (holder.is_locked ? '🔒 Locked' : holder.is_contract ? '📝 Contract' : '');
                                            return `
                                                <div style="font-size: 0.65rem;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.15rem; align-items: center;">
                                                        <span style="color: var(--text-tertiary); font-family: monospace;">
                                                            #${idx + 1} ${holder.address.substring(0, 6)}...${holder.address.substring(holder.address.length - 4)}
                                                            ${tag ? `<span style="color: ${barColor}; font-weight: 600; margin-left: 0.25rem;">${tag}</span>` : ''}
                                                        </span>
                                                        <span style="font-weight: 700; color: ${barColor};">${percent.toFixed(2)}%</span>
                                                    </div>
                                                    <div style="width: 100%; height: 6px; background: rgba(139, 92, 246, 0.1); border-radius: 3px; overflow: hidden;">
                                                        <div style="width: ${Math.min(percent, 100)}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : hasSecurity && token.security.data_warning === 'solana_beta_limited_data' ? `
                                <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(168, 85, 247, 0.03) 100%); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: #a855f7; font-weight: 600; margin-bottom: 0.35rem;">👥 Holder Data</div>
                                    <div style="font-size: 0.65rem; color: var(--text-tertiary); line-height: 1.4;">
                                        ℹ️ Holder data not available yet (GoPlus Solana API Beta)
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Technical Analysis Section (if available) -->
                            ${token.technical_analysis ? `
                                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.08) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.8rem; font-weight: 700; color: var(--accent-primary); text-transform: uppercase;">
                                            📊 Technical Analysis
                                        </div>
                                        ${token.technical_analysis.trading_signal ? (() => {
                                            const signal = token.technical_analysis.trading_signal.signal;
                                            const confidence = token.technical_analysis.trading_signal.confidence;
                                            const colors = {
                                                'STRONG_BUY': {bg: 'rgba(34, 197, 94, 0.2)', color: '#22c55e', icon: '🟢'},
                                                'BUY': {bg: 'rgba(74, 222, 128, 0.15)', color: '#4ade80', icon: '🟢'},
                                                'HOLD': {bg: 'rgba(156, 163, 175, 0.15)', color: '#9ca3af', icon: '⏸️'},
                                                'SELL': {bg: 'rgba(251, 146, 60, 0.15)', color: '#fb923c', icon: '🔴'},
                                                'STRONG_SELL': {bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444', icon: '🔴'}
                                            };
                                            const style = colors[signal] || colors.HOLD;
                                            return `
                                                <div style="background: ${style.bg}; border: 1.5px solid ${style.color}; border-radius: 0.5rem; padding: 0.4rem 0.75rem; display: flex; align-items: center; gap: 0.35rem;">
                                                    <span style="font-size: 0.9rem;">${style.icon}</span>
                                                    <div>
                                                        <div style="font-weight: 700; font-size: 0.75rem; color: ${style.color}; line-height: 1;">${signal.replace('_', ' ')}</div>
                                                        <div style="font-size: 0.6rem; color: var(--text-tertiary); line-height: 1; margin-top: 0.1rem;">${confidence}%</div>
                                                    </div>
                                                </div>
                                            `;
                                        })() : ''}
                                    </div>

                                    <!-- TA Indicators Grid -->
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                        ${token.technical_analysis.rsi !== null && token.technical_analysis.rsi !== undefined ? `
                                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.6rem;">
                                                <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.35rem; font-weight: 600;">📈 RSI</div>
                                                <div style="display: flex; align-items: baseline; gap: 0.35rem; margin-bottom: 0.35rem;">
                                                    <div style="font-size: 1.1rem; font-weight: 800; color: ${token.technical_analysis.rsi < 30 ? '#22c55e' : token.technical_analysis.rsi > 70 ? '#ef4444' : '#9ca3af'};">
                                                        ${token.technical_analysis.rsi.toFixed(1)}
                                                    </div>
                                                    <div style="font-size: 0.65rem; font-weight: 600; color: ${token.technical_analysis.rsi < 30 ? '#22c55e' : token.technical_analysis.rsi > 70 ? '#ef4444' : '#9ca3af'};">
                                                        ${token.technical_analysis.rsi < 30 ? 'OVERSOLD' : token.technical_analysis.rsi > 70 ? 'OVERBOUGHT' : 'NEUTRAL'}
                                                    </div>
                                                </div>
                                                <div style="width: 100%; height: 4px; background: linear-gradient(90deg, #22c55e 0%, #22c55e 30%, #9ca3af 30%, #9ca3af 70%, #ef4444 70%, #ef4444 100%); border-radius: 2px; position: relative;">
                                                    <div style="position: absolute; left: ${token.technical_analysis.rsi}%; top: 50%; transform: translate(-50%, -50%); width: 3px; height: 8px; background: white; border: 1px solid #333; border-radius: 1px;"></div>
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${token.technical_analysis.macd ? `
                                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.6rem;">
                                                <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.35rem; font-weight: 600;">📉 MACD</div>
                                                <div style="font-size: 1.1rem; font-weight: 800; color: ${token.technical_analysis.macd.trend === 'bullish' ? '#22c55e' : '#ef4444'}; margin-bottom: 0.25rem;">
                                                    ${token.technical_analysis.macd.trend === 'bullish' ? '↗️ BULLISH' : '↘️ BEARISH'}
                                                </div>
                                                <div style="font-size: 0.6rem; color: var(--text-tertiary);">
                                                    ${token.technical_analysis.macd.histogram > 0 ? '+' : ''}${token.technical_analysis.macd.histogram.toFixed(6)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${token.technical_analysis.bollinger_bands ? `
                                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.6rem;">
                                                <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.35rem; font-weight: 600;">📊 Bollinger</div>
                                                <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">
                                                    ${token.technical_analysis.bollinger_bands.position === 'above_upper' ? '🔴 Above' :
                                                      token.technical_analysis.bollinger_bands.position === 'below_lower' ? '🟢 Below' :
                                                      '⚪ Within'}
                                                </div>
                                                <div style="font-size: 0.6rem; color: var(--text-tertiary);">
                                                    BW: ${token.technical_analysis.bollinger_bands.bandwidth.toFixed(2)}%
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${token.technical_analysis.trend ? `
                                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.6rem;">
                                                <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.35rem; font-weight: 600;">📈 Trend</div>
                                                <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; text-transform: capitalize;">
                                                    ${token.technical_analysis.trend.trend.replace('_', ' ')}
                                                </div>
                                                <div style="font-size: 0.6rem; color: var(--text-tertiary);">
                                                    Strength: ${(token.technical_analysis.trend.strength * 100).toFixed(0)}%
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- Support/Resistance Quick View -->
                                    ${token.technical_analysis.support_resistance ? `
                                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle);">
                                            <div style="text-align: center;">
                                                <div style="font-size: 0.6rem; color: #22c55e; font-weight: 600; margin-bottom: 0.25rem;">🟢 SUPPORT</div>
                                                <div style="font-size: 0.7rem; font-weight: 700; color: #22c55e; font-family: monospace;">
                                                    ${token.technical_analysis.support_resistance.support && token.technical_analysis.support_resistance.support.length > 0 ?
                                                        '$' + token.technical_analysis.support_resistance.support[0].toFixed(8) : 'N/A'}
                                                </div>
                                            </div>
                                            <div style="text-align: center; padding: 0.35rem 0.5rem; background: var(--gradient-primary); border-radius: 0.35rem;">
                                                <div style="font-size: 0.55rem; color: rgba(255,255,255,0.8);">Current</div>
                                                <div style="font-size: 0.7rem; font-weight: 700; color: white; font-family: monospace;">
                                                    $${token.technical_analysis.support_resistance.current_price.toFixed(8)}
                                                </div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 0.6rem; color: #ef4444; font-weight: 600; margin-bottom: 0.25rem;">🔴 RESISTANCE</div>
                                                <div style="font-size: 0.7rem; font-weight: 700; color: #ef4444; font-family: monospace;">
                                                    ${token.technical_analysis.support_resistance.resistance && token.technical_analysis.support_resistance.resistance.length > 0 ?
                                                        '$' + token.technical_analysis.support_resistance.resistance[0].toFixed(8) : 'N/A'}
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : token.analysis_type === 'established_token_analysis' ? `
                                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #f59e0b; font-weight: 600; margin-bottom: 0.25rem;">📊 TA Unavailable</div>
                                    <div style="font-size: 0.65rem; color: var(--text-tertiary);">
                                        OHLCV data could not be fetched
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Compact Risk Scores Row -->
                            <div style="display: grid; grid-template-columns: ${hasTwitter ? 'repeat(2, 1fr)' : '1fr'}; gap: 0.5rem; margin-bottom: 0.75rem;">
                                ${hasTwitter ? `
                                    <div style="background: linear-gradient(135deg, rgba(29, 161, 242, 0.1) 0%, rgba(29, 161, 242, 0.05) 100%); border: 1px solid rgba(29, 161, 242, 0.2); border-radius: 0.5rem; padding: 0.75rem;">
                                        <div style="font-size: 0.7rem; color: #1da1f2; margin-bottom: 0.3rem; font-weight: 600;">🐦 SOCIAL</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #1da1f2;">${socialScore}/100</div>
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary);">${formatNumber(followers)} followers</div>
                                    </div>
                                ` : ''}
                                <div style="background: linear-gradient(135deg, ${pumpColor}15 0%, ${pumpColor}08 100%); border: 1px solid ${pumpColor}66; border-radius: 0.5rem; padding: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: ${pumpColor}; margin-bottom: 0.3rem; font-weight: 600;">🚨 P&D RISK</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${pumpColor};">${pumpScore}/100</div>
                                    <div style="font-size: 0.65rem; font-weight: 600; color: ${pumpColor};">${pumpRisk}</div>
                                </div>
                            </div>

                            <!-- Compact Warnings -->
                            ${(token.warnings && token.warnings.length > 0) || (token.pump_dump_warnings && token.pump_dump_warnings.length > 0) ? `
                                <div style="background: rgba(239, 68, 68, 0.08); border-left: 3px solid #ef4444; border-radius: 0.5rem; padding: 0.6rem 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-weight: 600; font-size: 0.75rem; color: #ef4444; margin-bottom: 0.4rem;">⚠️ WARNINGS</div>
                                    <div style="font-size: 0.7rem; color: var(--text-secondary); line-height: 1.4;">
                                        ${(() => {
                                            const allWarnings = [...(token.warnings || []), ...(token.pump_dump_warnings || [])];
                                            const displayWarnings = allWarnings.slice(0, 3).map(w => `• ${w}`).join(' ');
                                            const moreCount = allWarnings.length > 3 ? ` <span style="color: #f59e0b;">+${allWarnings.length - 3} more</span>` : '';
                                            return displayWarnings + moreCount;
                                        })()}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Compact Action Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                                <button onclick="event.stopPropagation(); analyzeTokenWithAI(${index}, this);" style="padding: 0.6rem 0.75rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3); font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)';" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                                    <span>🤖</span>
                                    <span>AI</span>
                                </button>
                                ${token.url ? `
                                    <a href="${token.url}" target="_blank" style="padding: 0.6rem 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.borderColor='var(--accent-primary)';" onmouseleave="this.style.transform='scale(1)'; this.style.borderColor='var(--border-subtle)';">
                                        <span>📊</span>
                                        <span>Dex</span>
                                    </a>
                                ` : ''}
                                ${token.twitter ? `
                                    <a href="${token.twitter}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(29, 161, 242, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(29, 161, 242, 0.1)';">
                                        <span>🐦</span>
                                        <span>X</span>
                                    </a>
                                ` : ''}
                                ${token.website ? `
                                    <a href="${token.website}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(139, 92, 246, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(139, 92, 246, 0.1)';">
                                        <span>🌐</span>
                                        <span>Web</span>
                                    </a>
                                ` : ''}
                                ${token.telegram ? `
                                    <a href="${token.telegram}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(34, 197, 233, 0.1); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(34, 197, 233, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(34, 197, 233, 0.1)';">
                                        <span>✈️</span>
                                        <span>TG</span>
                                    </a>
                                ` : ''}
                                ${token.discord ? `
                                    <a href="${token.discord}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(88, 101, 242, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(88, 101, 242, 0.1)';">
                                        <span>💬</span>
                                        <span>DC</span>
                                    </a>
                                ` : ''}
                            </div>

                            <!-- AI Analysis Result -->
                            <div id="ai-result-${token.address}" style="display: none; margin-top: 1.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                    <span style="font-size: 1.5rem;">🤖</span>
                                    <h5 style="font-weight: 700; font-size: 1.125rem;">Analyse Claude IA</h5>
                                </div>
                                <div id="ai-content-${token.address}" style="color: var(--text-secondary); line-height: 1.8; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid var(--accent-primary); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                        <h3 style="font-size: 1.75rem; font-weight: 900; margin-bottom: 0.5rem;">✅ Scan Terminé !</h3>
                        <p style="color: var(--text-secondary); font-size: 1.125rem;">
                            ${data.results.length} token(s) analysé(s) •
                            <span style="color: #22c55e; font-weight: 600;">${data.safe_count || 0} sûrs</span> •
                            <span style="color: #ef4444; font-weight: 600;">${data.dangerous_count || 0} risqués</span> •
                            <span style="color: #f59e0b; font-weight: 600;">${data.pump_dump_suspects_count || 0} P&D suspects</span>
                        </p>
                        <p style="color: var(--accent-success); font-size: 0.875rem; margin-top: 0.5rem;">
                            💾 Tokens sauvegardés en base de données
                        </p>
                    </div>
                    ${tokensHTML}
                `;

                // Refresh stats
                loadUserInfo();

                // Update favorite buttons state
                updateFavoriteButtons();
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🤷</div>
                        <p>Aucun token trouvé</p>
                    </div>
                `;
            }
        }

        // AI Token Analysis
        async function analyzeTokenWithAI(tokenIndex, buttonElement) {
            // Get token data from global array
            const tokenData = window.currentTokens[tokenIndex];
            if (!tokenData) {
                console.error('Token not found at index:', tokenIndex);
                return;
            }

            const address = tokenData.address;
            const chain = tokenData.chain;
            const resultDiv = document.getElementById(`ai-result-${address}`);
            const contentDiv = document.getElementById(`ai-content-${address}`);

            // Show loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span>⏳</span><span>Analyse en cours...</span>';
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><div style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 0.5rem;">Claude analyse le token...</p></div>';

            try {
                const response = await fetch('/api/analyze-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        chain: chain,
                        token_data: tokenData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    contentDiv.innerHTML = data.analysis || 'Analyse terminée.';
                } else {
                    contentDiv.innerHTML = `<div style="color: #ef4444;">❌ Erreur: ${data.error || 'Impossible d\'analyser le token'}</div>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: #ef4444;">❌ Erreur de connexion: ${error.message}</div>`;
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<span>🤖</span><span>Scan par IA</span>';
            }
        }

        // ==================== AUTO-SCAN SYSTEM ====================
        let autoScanInterval = null;
        let countdownInterval = null;
        let secondsRemaining = 300; // 5 minutes = 300 seconds

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateCountdown() {
            const timerElement = document.getElementById('countdown-timer');
            if (timerElement) {
                timerElement.textContent = formatTime(secondsRemaining);

                // Color change based on time remaining
                if (secondsRemaining <= 30) {
                    timerElement.style.color = '#ef4444'; // Red when <30s
                } else if (secondsRemaining <= 60) {
                    timerElement.style.color = '#f59e0b'; // Orange when <1min
                } else {
                    timerElement.style.color = 'var(--accent-primary)'; // Normal
                }
            }

            secondsRemaining--;

            if (secondsRemaining < 0) {
                // Time's up! Trigger auto-scan
                secondsRemaining = 300; // Reset to 5 minutes
                triggerAutoScan();
            }
        }

        async function triggerAutoScan() {
            console.log('🤖 Auto-scan triggered!');

            // Check if already scanning
            const btn = document.getElementById('start-scan-btn');
            if (btn.disabled) {
                console.log('⏸️ Scan already in progress, skipping auto-scan');
                return;
            }

            // Trigger scan with notification
            const countdownDiv = document.getElementById('auto-scan-countdown');
            const originalHTML = countdownDiv.innerHTML;

            // Show auto-scan message
            countdownDiv.innerHTML = `
                <span>🤖</span>
                <span>Scan automatique en cours...</span>
            `;
            countdownDiv.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2))';
            countdownDiv.style.borderColor = 'var(--accent-primary)';

            // Start scan
            await startScan();

            // Wait a bit before resetting display
            setTimeout(() => {
                countdownDiv.innerHTML = originalHTML;
                countdownDiv.style.background = 'var(--bg-glass)';
                countdownDiv.style.borderColor = '';
            }, 3000);
        }

        function startAutoScanSystem() {
            console.log('🚀 Auto-scan system initialized (5-minute intervals)');

            // Start countdown
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdown, 1000);

            // Initial countdown display
            updateCountdown();
        }

        function stopAutoScanSystem() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            console.log('⏹️ Auto-scan system stopped');
        }

        // ==================== CRYPTO NEWS ====================
        async function loadCryptoNews(forceRefresh = false) {
            const newsList = document.getElementById('news-list');
            const cacheInfo = document.getElementById('news-cache-info');

            try {
                const url = `/api/news/crypto?limit=10&force_refresh=${forceRefresh}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.articles) {
                    // Display cache info
                    if (data.cached) {
                        const expiresMin = Math.floor(data.cache_expires_in / 60);
                        cacheInfo.textContent = `✅ Cache actif - Expire dans ${expiresMin} minutes`;
                        cacheInfo.style.color = 'var(--accent-success)';
                    } else {
                        cacheInfo.textContent = `🆕 Actualités fraîches - Cache valide 30 minutes`;
                        cacheInfo.style.color = 'var(--accent-primary)';
                    }

                    // Display articles
                    newsList.innerHTML = data.articles.map((article, index) => `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s; cursor: pointer;" onmouseenter="this.style.borderColor='var(--accent-primary)'" onmouseleave="this.style.borderColor='var(--border-subtle)'" onclick="window.open('${article.url}', '_blank')">
                            <div style="display: flex; gap: 1rem;">
                                ${article.image_url ? `
                                    <img src="${article.image_url}" style="width: 80px; height: 80px; border-radius: 0.5rem; object-fit: cover;" onerror="this.style.display='none'">
                                ` : ''}
                                <div style="flex: 1;">
                                    <h4 style="font-size: 0.95rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">${article.title}</h4>
                                    <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                        <span>📅 ${article.published_date}</span>
                                        <span>📰 ${article.source}</span>
                                        ${article.sentiment !== 'NEUTRAL' ? `<span style="color: ${article.sentiment === 'POSITIVE' ? '#22c55e' : '#ef4444'};">● ${article.sentiment}</span>` : ''}
                                    </div>
                                    ${article.categories.length > 0 ? `
                                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                            ${article.categories.slice(0, 3).map(cat => `<span style="background: var(--bg-glass); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.65rem; color: var(--text-secondary);">${cat}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    console.log(`✅ Loaded ${data.articles.length} news articles`);
                } else {
                    newsList.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">📭</div><p>Aucune actualité disponible</p></div>`;
                }
            } catch (error) {
                console.error('Error loading news:', error);
                newsList.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--accent-danger);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">❌</div><p>Erreur de chargement des actualités</p></div>`;
            }
        }

        async function refreshNews() {
            const refreshIcon = document.getElementById('news-refresh-icon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            await loadCryptoNews(true);
            setTimeout(() => {
                refreshIcon.style.animation = 'none';
            }, 1000);
        }

        // ==================== CRYPTO NEWS SIDEBAR ====================
        async function loadCryptoNewsSidebar(forceRefresh = false) {
            const newsList = document.getElementById('news-sidebar-list');
            if (!newsList) return;

            try {
                const url = `/api/news/crypto?limit=8&force_refresh=${forceRefresh}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.articles && data.articles.length > 0) {
                    // Display compact news cards
                    newsList.innerHTML = data.articles.map((article, index) => `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; transition: all 0.2s; cursor: pointer;"
                             onmouseenter="this.style.borderColor='var(--accent-success)'; this.style.transform='translateX(4px)'"
                             onmouseleave="this.style.borderColor='var(--border-subtle)'; this.style.transform='translateX(0)'"
                             onclick="window.open('${article.url}', '_blank')">
                            <h4 style="font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${article.title}
                            </h4>
                            <div style="display: flex; gap: 0.75rem; font-size: 0.7rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                <span>📅 ${article.published_date}</span>
                                <span>📰 ${article.source}</span>
                            </div>
                            ${article.sentiment !== 'NEUTRAL' ? `
                                <div style="display: inline-block; padding: 0.15rem 0.5rem; background: ${article.sentiment === 'POSITIVE' ? 'rgba(34, 197, 94, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; border-radius: 0.375rem; font-size: 0.65rem; color: ${article.sentiment === 'POSITIVE' ? '#22c55e' : '#ef4444'}; font-weight: 600;">
                                    ${article.sentiment === 'POSITIVE' ? '📈 Positif' : '📉 Négatif'}
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    console.log(`✅ Loaded ${data.articles.length} news in sidebar`);
                } else {
                    newsList.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">📭</div>
                            <p style="font-size: 0.85rem;">Aucune actualité disponible</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading sidebar news:', error);
                newsList.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 2rem; color: var(--accent-danger);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">❌</div>
                        <p style="font-size: 0.85rem;">Erreur de chargement</p>
                    </div>
                `;
            }
        }

        async function refreshNewsSidebar() {
            const refreshIcon = document.getElementById('news-sidebar-refresh-icon');
            if (refreshIcon) {
                refreshIcon.style.animation = 'spin 1s linear infinite';
            }
            await loadCryptoNewsSidebar(true);
            setTimeout(() => {
                if (refreshIcon) {
                    refreshIcon.style.animation = 'none';
                }
            }, 1000);
        }

        // ==================== TOKEN DETAILS MODAL ====================
        function showTokenDetailsModal(token) {
            const modal = document.getElementById('token-details-modal');
            const headerContent = document.getElementById('modal-header-content');
            const bodyContent = document.getElementById('modal-body-content');

            if (!modal || !headerContent || !bodyContent) return;

            // Extraire les données
            const hasMarketData = token.market && !token.market.error;
            const hasSecurity = token.security && !token.security.error;
            const price = hasMarketData ? token.market.price_usd : 0;
            const change24h = hasMarketData ? (token.market.price_change_24h || 0) : 0;
            const change6h = hasMarketData ? (token.market.price_change_6h || 0) : 0;
            const change1h = hasMarketData ? (token.market.price_change_1h || 0) : 0;
            const liquidity = hasMarketData ? (token.market.liquidity_usd || 0) : 0;
            const volume24h = hasMarketData ? (token.market.volume_24h || 0) : 0;
            const marketCap = hasMarketData ? (token.market.market_cap || 0) : 0;
            const buys = hasMarketData ? (token.market.txns_24h_buys || 0) : 0;
            const sells = hasMarketData ? (token.market.txns_24h_sells || 0) : 0;
            const pairAge = hasMarketData ? token.market.pair_created_at : 'N/A';
            const buyTax = hasSecurity ? (token.security.buy_tax || 0) : 0;
            const sellTax = hasSecurity ? (token.security.sell_tax || 0) : 0;
            const holders = hasSecurity ? (token.security.holder_count || 'N/A') : 'N/A';
            const isHoneypot = hasSecurity ? token.security.is_honeypot : false;
            const riskScore = token.risk_score || 50;
            const riskColor = riskScore < 30 ? '#22c55e' : riskScore < 70 ? '#f59e0b' : '#ef4444';

            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                return num.toFixed(2);
            };
            const formatPrice = (p) => {
                if (p >= 1) return '$' + p.toFixed(4);
                if (p >= 0.0001) return '$' + p.toFixed(6);
                return '$' + p.toExponential(2);
            };
            const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';
            const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';

            // Header
            headerContent.innerHTML = `
                <div style="display: flex; gap: 1rem; align-items: start;">
                    ${token.icon ? `<img src="${token.icon}" alt="${token.name}" style="width: 80px; height: 80px; border-radius: 1rem; background: var(--bg-glass); padding: 0.5rem;">` : `<div style="width: 80px; height: 80px; border-radius: 1rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">🪙</div>`}
                    <div style="flex: 1;">
                        <h2 style="font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem;">${token.name || token.symbol || 'Unknown Token'}</h2>
                        <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">${token.address || 'N/A'}</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="padding: 0.4rem 0.75rem; background: rgba(102, 126, 234, 0.15); color: #667eea; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">${token.chain || 'Unknown'}</span>
                            ${token.is_safe ? '<span style="padding: 0.4rem 0.75rem; background: rgba(34, 197, 94, 0.15); color: #22c55e; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">✅ Safe</span>' : '<span style="padding: 0.4rem 0.75rem; background: rgba(239, 68, 68, 0.15); color: #ef4444; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">⚠️ Risky</span>'}
                            ${token.is_pump_dump_suspect ? '<span style="padding: 0.4rem 0.75rem; background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">🚨 Pump & Dump Suspect</span>' : ''}
                            <span style="padding: 0.4rem 0.75rem; background: ${riskColor}; color: white; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 700;">Risk Score: ${riskScore}</span>
                        </div>
                    </div>
                </div>
            `;

            // Body with detailed stats
            bodyContent.innerHTML = `
                <!-- Price & Changes -->
                ${hasMarketData ? `
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span>💰</span> Prix & Performance
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">Prix actuel</div>
                                <div style="font-size: 2rem; font-weight: 900;">${formatPrice(price)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">24h Change</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${colorChange(change24h)};">${formatChange(change24h)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">6h Change</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${colorChange(change6h)};">${formatChange(change6h)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">1h Change</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${colorChange(change1h)};">${formatChange(change1h)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Stats -->
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span>📊</span> Statistiques de Marché
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">💧 Liquidité</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">$${formatNumber(liquidity)}</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">📊 Volume 24h</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">$${formatNumber(volume24h)}</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">💎 Market Cap</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">$${formatNumber(marketCap)}</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">⏰ Âge du Pair</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${pairAge !== 'N/A' ? Math.floor((Date.now() - pairAge * 1000) / (1000 * 60 * 60)) + 'h' : 'N/A'}</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">🟢 Achats 24h</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">${buys}</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.1); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">🔴 Ventes 24h</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${sells}</div>
                            </div>
                        </div>
                    </div>
                ` : '<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem; text-align: center;"><div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div><div style="color: #ef4444; font-weight: 700; font-size: 1.25rem;">Données de marché indisponibles</div></div>'}

                <!-- Security Info -->
                ${hasSecurity ? `
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 2rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span>🔒</span> Sécurité
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">Taxe d'achat</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${buyTax > 10 ? '#ef4444' : buyTax > 5 ? '#f59e0b' : '#22c55e'};">${buyTax.toFixed(1)}%</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">Taxe de vente</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${sellTax > 10 ? '#ef4444' : sellTax > 5 ? '#f59e0b' : '#22c55e'};">${sellTax.toFixed(1)}%</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">Honeypot</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${isHoneypot ? '#ef4444' : '#22c55e'};">${isHoneypot ? '❌ OUI' : '✅ NON'}</div>
                            </div>
                            <div style="background: var(--bg-glass); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 0.5rem;">Holders</div>
                                <div style="font-size: 1.75rem; font-weight: 700;">${holders !== 'N/A' ? formatNumber(parseInt(holders)) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Links -->
                <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 2rem;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span>🔗</span> Liens
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        ${token.url ? `<a href="${token.url}" target="_blank" style="padding: 1rem; background: var(--gradient-primary); color: white; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);"><span style="font-size: 1.5rem;">📊</span><span>DexScreener</span></a>` : ''}
                        ${token.twitter ? `<a href="${token.twitter}" target="_blank" style="padding: 1rem; background: rgba(29, 161, 242, 0.15); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s;"><span style="font-size: 1.5rem;">🐦</span><span>Twitter/X</span></a>` : ''}
                        ${token.website ? `<a href="${token.website}" target="_blank" style="padding: 1rem; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s;"><span style="font-size: 1.5rem;">🌐</span><span>Website</span></a>` : ''}
                        ${token.telegram ? `<a href="${token.telegram}" target="_blank" style="padding: 1rem; background: rgba(34, 197, 233, 0.15); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s;"><span style="font-size: 1.5rem;">✈️</span><span>Telegram</span></a>` : ''}
                        ${token.discord ? `<a href="${token.discord}" target="_blank" style="padding: 1rem; background: rgba(88, 101, 242, 0.15); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; border-radius: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s;"><span style="font-size: 1.5rem;">💬</span><span>Discord</span></a>` : ''}
                    </div>
                </div>
            `;

            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeTokenDetailsModal(event) {
            const modal = document.getElementById('token-details-modal');
            if (!modal) return;

            // Si event fourni, vérifier qu'on clique bien sur le backdrop
            if (event && event.target !== modal) return;

            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Fermer avec la touche Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTokenDetailsModal();
            }
        });

        // ==================== TOKEN SEARCH ====================
        async function searchToken() {
            const input = document.getElementById('token-search-input');
            const resultsDiv = document.getElementById('token-search-results');
            const query = input.value.trim();

            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            // Show loading
            resultsDiv.innerHTML = `<div class="loading" style="text-align: center; padding: 1rem;"><div class="spinner" style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>`;

            try {
                const response = await fetch(`/api/token/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success && data.tokens && data.tokens.length > 0) {
                    resultsDiv.innerHTML = data.tokens.map(token => `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem; margin-top: 1rem;">
                            <div style="display: flex; gap: 1rem; align-items: start; margin-bottom: 1rem;">
                                ${token.logo ? `<img src="${token.logo}" style="width: 56px; height: 56px; border-radius: 0.75rem;">` : '<div style="width: 56px; height: 56px; border-radius: 0.75rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">🪙</div>'}
                                <div style="flex: 1;">
                                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">${token.name} <span style="color: var(--text-secondary); font-weight: 600;">(${token.symbol})</span></h3>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                        ${token.category ? `<span style="background: var(--bg-glass); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; text-transform: uppercase; margin-right: 0.5rem;">${token.category}</span>` : ''}
                                        ${token.date_launched ? `Lancé: ${new Date(token.date_launched).toLocaleDateString('fr-FR')}` : ''}
                                    </div>
                                    ${token.tags && token.tags.length > 0 ? `
                                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                                            ${token.tags.slice(0, 5).map(tag => `<span style="background: rgba(102, 126, 234, 0.1); color: var(--accent-primary); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.7rem;">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            ${token.description ? `<p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">${token.description.substring(0, 300)}${token.description.length > 300 ? '...' : ''}</p>` : ''}

                            ${token.urls ? `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem;">
                                    ${token.urls.website && token.urls.website.length > 0 ? `<a href="${token.urls.website[0]}" target="_blank" style="padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🌐 Website</a>` : ''}
                                    ${token.urls.twitter && token.urls.twitter.length > 0 ? `<a href="${token.urls.twitter[0]}" target="_blank" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">𝕏 Twitter</a>` : ''}
                                    ${token.urls.reddit && token.urls.reddit.length > 0 ? `<a href="${token.urls.reddit[0]}" target="_blank" style="padding: 0.5rem; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); color: #f97316; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🔶 Reddit</a>` : ''}
                                    ${token.urls.explorer && token.urls.explorer.length > 0 ? `<a href="${token.urls.explorer[0]}" target="_blank" style="padding: 0.5rem; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🔍 Explorer</a>` : ''}
                                    ${token.urls.source_code && token.urls.source_code.length > 0 ? `<a href="${token.urls.source_code[0]}" target="_blank" style="padding: 0.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-secondary); text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">💻 Code</a>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    console.log(`✅ Found ${data.tokens.length} token(s)`);
                } else {
                    resultsDiv.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">🔍</div><p>Aucun token trouvé pour "${query}"</p><p style="font-size: 0.8rem; margin-top: 0.5rem;">Essayez avec un symbole (BTC, ETH) ou nom complet (bitcoin, ethereum)</p></div>`;
                }
            } catch (error) {
                console.error('Error searching token:', error);
                resultsDiv.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--accent-danger);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">❌</div><p>Erreur de recherche</p></div>`;
            }
        }

        // ==================== SPECIFIC TOKEN SEARCH ====================
        async function searchSpecificToken() {
            const input = document.getElementById('tokenSearchInput');
            const value = input.value.trim();

            if (!value) {
                alert('⚠️ Veuillez entrer une adresse de token ou une URL DexScreener');
                return;
            }

            // Show loading state
            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-results').style.display = 'none';

            try {
                let profileUrl = '';

                // Check if it's a full DexScreener URL
                if (value.includes('dexscreener.com')) {
                    profileUrl = value;
                } else {
                    // It's just an address - need to prompt for chain
                    const chain = prompt('🔗 Quelle blockchain?\n\nEntrez: solana, ethereum, bsc, base, arbitrum, polygon', 'solana');
                    if (!chain) {
                        document.getElementById('scan-progress').style.display = 'none';
                        return;
                    }
                    profileUrl = `https://dexscreener.com/${chain.toLowerCase()}/${value}`;
                }

                console.log('🔍 Searching token:', profileUrl);

                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        max_tokens: 1,
                        profile_url: profileUrl
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Poll for results
                    pollScanResults();
                } else {
                    document.getElementById('scan-progress').style.display = 'none';
                    alert('❌ Erreur: ' + (data.error || 'Scan échoué'));
                }

            } catch (error) {
                console.error('Error searching token:', error);
                document.getElementById('scan-progress').style.display = 'none';
                alert('❌ Erreur lors de la recherche du token');
            }
        }

        // Initialize
        loadUserInfo();
        loadTokensFromDatabase();  // Load tokens from database on page load
        loadCryptoNews();  // Load crypto news on page load
        loadCryptoNewsSidebar();  // Load crypto news in sidebar
        startAutoScanSystem();

        // Auto-refresh tokens from database every 5 minutes (sync with auto-scan)
        setInterval(() => {
            console.log('🔄 Auto-refreshing tokens from database...');
            loadTokensFromDatabase();
        }, 5 * 60 * 1000);  // 5 minutes

        // Stop auto-scan when user leaves page
        window.addEventListener('beforeunload', () => {
            stopAutoScanSystem();
        });
    </script>

    <!-- Auth Modal (Login/Register) -->
    {% include 'components_auth_modal.html' %}

    <!-- Reusable Component Functions -->
    <script src="{{ url_for('static', filename='components.js') }}"></script>
</body>
</html>
