<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Token Scanner Pro 🚀</title>
    <meta name="description" content="Scannez, analysez et tradez les tokens crypto avant tout le monde. IA + Analyse en temps réel.">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: rgba(26, 26, 36, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #0cebeb 0%, #20e3b2 100%);
            --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-gold: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b2;
            --text-tertiary: #6b6b80;
            --accent-primary: #667eea;
            --accent-success: #20e3b2;
            --accent-danger: #f5576c;
            --border-subtle: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Welcome Section */
        .welcome {
            margin-bottom: 2rem;
        }

        .welcome h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        /* Stats Overview Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-change.positive {
            background: rgba(32, 227, 178, 0.1);
            color: var(--accent-success);
        }

        .stat-change.negative {
            background: rgba(245, 87, 108, 0.1);
            color: var(--accent-danger);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Scanner Section */
        .scanner-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scan-config {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            padding: 0.75rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Recent Activity */
        .activity-feed {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Auto-Scan Preview */
        .autoscan-preview {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
            margin-bottom: 2rem;
        }

        .autoscan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(32, 227, 178, 0.1);
            border: 1px solid var(--accent-success);
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-success);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .tokens-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .token-card-mini {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s;
        }

        .token-card-mini:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--bg-glass);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .welcome h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }

            .welcome h1 {
                font-size: 1.75rem;
            }

            .welcome p {
                font-size: 1rem !important;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            /* Token cards grid - 1 column on mobile */
            .tokens-grid {
                grid-template-columns: 1fr !important;
            }

            /* Search input stack on mobile */
            #token-search-input {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .welcome {
                padding: 2rem 0;
            }

            .welcome h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.75rem !important;
            }

            /* Modal responsive */
            #token-details-modal > div {
                padding: 1rem !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }

            #token-details-modal {
                padding: 0 !important;
            }
        }

        /* Amélioration responsive pour les petits écrans */
        @media (max-width: 480px) {
            .section-title {
                font-size: 1.25rem;
            }

            /* Search form stack */
            .search-form {
                flex-direction: column !important;
            }

            .search-btn {
                width: 100% !important;
                padding: 1rem !important;
            }

            /* News refresh button */
            .activity-feed > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }
        }
    </style>
</head>
<body data-page="home">
    <!-- Navigation Component -->
    {% include 'components_nav.html' %}

    <!-- Barre de progression Auto-Scan (Discrète) -->
    {% include 'components_scan_progress.html' %}

    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid var(--border-subtle); border-radius: 1.5rem; padding: 3rem 2rem; margin-bottom: 2.5rem; text-align: center; backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);">
            <h1 style="font-size: 3rem; font-weight: 900; margin-bottom: 1rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInUp 0.6s ease-out;">
                👋 Bienvenue, <span id="welcome-name">Trader</span>
            </h1>
            <p style="color: var(--text-secondary); font-size: 1.25rem; max-width: 700px; margin: 0 auto; animation: fadeInUp 0.6s ease-out 0.2s backwards;">
                Votre tableau de bord personnalisé pour le trading crypto intelligent 🚀
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap; animation: fadeInUp 0.6s ease-out 0.4s backwards;">
                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); padding: 0.75rem 1.5rem; border-radius: 2rem; color: #22c55e; font-weight: 600;">
                    ✅ Scanner IA Activé
                </div>
                <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); padding: 0.75rem 1.5rem; border-radius: 2rem; color: var(--accent-primary); font-weight: 600;">
                    📊 Auto-Scan 5min
                </div>
                <div style="background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); padding: 0.75rem 1.5rem; border-radius: 2rem; color: #f97316; font-weight: 600;">
                    💾 <span id="cache-badge">0</span> Tokens en Cache
                </div>
            </div>
        </div>

        <style>
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Scans Effectués</span>
                    <span class="stat-icon">🔍</span>
                </div>
                <div class="stat-value" id="total-scans">0</div>
                <div class="stat-subtitle">
                    <span class="stat-change positive" style="display: none;">
                        <span>↑</span>
                        <span id="scans-change">0%</span>
                    </span>
                    <span>Cette semaine</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Mes Favoris</span>
                    <span class="stat-icon">⭐</span>
                </div>
                <div class="stat-value" id="total-favorites">0</div>
                <div class="stat-subtitle">Tokens surveillés</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Tokens Cachés</span>
                    <span class="stat-icon">🗄️</span>
                </div>
                <div class="stat-value" id="cache-tokens">0</div>
                <div class="stat-subtitle">Auto-scan 24h</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Alertes Actives</span>
                    <span class="stat-icon">🚨</span>
                </div>
                <div class="stat-value" id="active-alerts">0</div>
                <div class="stat-subtitle" id="alerts-subtitle">Premium requis</div>
            </div>
        </div>

        <!-- Auto-Scan Preview -->
        <div class="autoscan-preview" id="autoscan-preview" style="display: none;">
            <div class="autoscan-header">
                <div>
                    <h2 class="section-title">🤖 Tokens Auto-Scannés</h2>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                        Les derniers tokens détectés automatiquement
                    </p>
                </div>
                <div>
                    <span class="status-badge">
                        <span class="pulse-dot"></span>
                        <span>Scanner actif</span>
                    </span>
                </div>
            </div>

            <div id="autoscan-tokens" class="tokens-preview"></div>

            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="/auto-scan" class="btn btn-primary">
                    Voir tous les tokens →
                </a>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Scanner Section -->
            <div class="scanner-section" id="scanner">
                <div class="section-header">
                    <h2 class="section-title">🔍 Scanner un Token</h2>
                </div>

                <div class="scan-config">
                    <div class="input-group">
                        <label for="max-tokens">Nombre de tokens à scanner</label>
                        <select id="max-tokens">
                            <option value="5">5 tokens</option>
                            <option value="10" selected>10 tokens</option>
                            <option value="20">20 tokens</option>
                            <option value="50">50 tokens</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" id="start-scan-btn" onclick="startScan()" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 0.75rem; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                    <span style="font-size: 1.25rem;">🚀</span>
                    <span>Lancer le Scanner IA</span>
                </button>

                <!-- Auto-scan countdown indicator -->
                <div id="auto-scan-countdown" style="margin-top: 1rem; text-align: center; padding: 0.75rem; background: var(--bg-glass); border-radius: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="opacity: 0.6;">⏰</span>
                    <span>Prochain scan automatique dans <strong id="countdown-timer" style="color: var(--accent-primary);">5:00</strong></span>
                </div>

                <div id="scan-progress" style="margin-top: 1.5rem; display: none;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">Scan en cours...</p>
                        <p id="scan-status" style="font-size: 0.875rem; color: var(--text-secondary);"></p>
                    </div>
                </div>

                <div id="scan-results" style="margin-top: 1.5rem; display: none;">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <!-- Crypto News -->
            <div class="activity-feed" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="section-title">📰 Actualités Crypto</h3>
                    <button onclick="refreshNews()" style="padding: 0.5rem 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; transition: all 0.2s;">
                        <span id="news-refresh-icon">🔄</span> Actualiser
                    </button>
                </div>
                <div id="news-cache-info" style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.75rem;"></div>
                <div id="news-list">
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        <div class="spinner" style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">Chargement des actualités...</p>
                    </div>
                </div>
            </div>

            <!-- Token Search -->
            <div class="activity-feed" style="margin-top: 2rem;">
                <h3 class="section-title" style="margin-bottom: 1rem;">🔍 Rechercher un Token</h3>
                <div class="search-form" style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <input
                        type="text"
                        id="token-search-input"
                        placeholder="Ex: BTC, ETH, bitcoin, ethereum..."
                        style="flex: 1; padding: 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.9rem;"
                        onkeypress="if(event.key === 'Enter') searchToken()"
                    />
                    <button onclick="searchToken()" class="search-btn" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); white-space: nowrap;">
                        Rechercher
                    </button>
                </div>
                <div id="token-search-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Load user info and update welcome
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();

                if (data.authenticated && data.user) {
                    const user = data.user;
                    document.getElementById('welcome-name').textContent = user.username;

                    // Update stats
                    document.getElementById('total-scans').textContent = user.scan_count || 0;

                    // Load other stats
                    await loadFavoritesCount();
                    await loadCacheStats();
                    await loadAlertsCount();
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Load favorites count
        async function loadFavoritesCount() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('total-favorites').textContent = data.favorites.length;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load cache stats
        async function loadCacheStats() {
            try {
                // Use scanned-tokens stats API
                const response = await fetch('/api/scanned-tokens/stats');
                const data = await response.json();
                if (data.success) {
                    const totalTokens = data.total_tokens || 0;
                    document.getElementById('cache-tokens').textContent = totalTokens;

                    // Update welcome badge
                    const cacheBadge = document.getElementById('cache-badge');
                    if (cacheBadge) {
                        cacheBadge.textContent = totalTokens;
                    }

                    // Show auto-scan preview if cache has tokens
                    if (totalTokens > 0) {
                        const autoscanPreview = document.getElementById('autoscan-preview');
                        if (autoscanPreview) {
                            autoscanPreview.style.display = 'block';
                            await loadAutoScanPreview();
                        }
                    }
                }
            } catch (error) {
                // Auto-scan not available
                console.log('Auto-scan not available');
            }
        }

        // Load auto-scan preview
        async function loadAutoScanPreview() {
            try {
                const response = await fetch('/api/auto-scan/tokens/recent?limit=6');
                const data = await response.json();

                if (data.success && data.tokens.length > 0) {
                    const container = document.getElementById('autoscan-tokens');
                    container.innerHTML = '';

                    data.tokens.slice(0, 6).forEach(token => {
                        const card = document.createElement('div');
                        card.className = 'token-card-mini';
                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; font-size: 0.875rem;">${token.chain.toUpperCase()}</div>
                                <div style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.5rem; ${token.is_safe ? 'background: rgba(32, 227, 178, 0.1); color: #20e3b2;' : 'background: rgba(245, 87, 108, 0.1); color: #f5576c;'}">
                                    ${token.is_safe ? '✅ Sûr' : '⚠️ Risqué'}
                                </div>
                            </div>
                            <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                ${token.address.substring(0, 8)}...${token.address.substring(token.address.length - 6)}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Risk: ${token.risk_score}/100
                            </div>
                        `;
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            window.location.href = `/auto-scan`;
                        });
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load alerts count (placeholder)
        async function loadAlertsCount() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                if (data.authenticated && data.user && data.user.is_premium) {
                    document.getElementById('active-alerts').textContent = '0';
                    document.getElementById('alerts-subtitle').textContent = 'Aucune alerte';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Scroll to scanner
        function scrollToScanner() {
            document.getElementById('scanner').scrollIntoView({ behavior: 'smooth' });
        }

        // Toggle favorite
        async function toggleFavorite(address, chain, tokenIndex) {
            const tokenData = window.currentTokens[tokenIndex];
            if (!tokenData) {
                console.error('Token not found');
                return;
            }

            const btn = document.getElementById(`fav-btn-${address}`);

            try {
                // Check if already favorited
                const checkResponse = await fetch('/api/favorites');
                const checkData = await checkResponse.json();

                const isFavorited = checkData.success && checkData.favorites.some(fav =>
                    fav.token_address === address && fav.chain === chain
                );

                if (isFavorited) {
                    // Remove from favorites
                    const response = await fetch('/api/favorites/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token_address: address, chain: chain })
                    });

                    const data = await response.json();
                    if (data.success) {
                        btn.innerHTML = '<span style="font-size: 1.25rem;">⭐</span>';
                        btn.style.background = 'rgba(0, 0, 0, 0.5)';
                        console.log('✅ Retiré des favoris');
                    }
                } else {
                    // Add to favorites
                    const response = await fetch('/api/favorites/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token_address: address,
                            chain: chain,
                            token_data: tokenData
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        btn.innerHTML = '<span style="font-size: 1.25rem;">⭐</span>';
                        btn.style.background = 'rgba(255, 215, 0, 0.3)';
                        btn.style.borderColor = '#ffd700';
                        console.log('✅ Ajouté aux favoris');
                    }
                }

                // Refresh favorites count
                await loadFavoritesCount();
            } catch (error) {
                console.error('Erreur favoris:', error);
            }
        }

        // Start scan
        async function startScan() {
            // Reset auto-scan countdown to 5 minutes when manual scan starts
            if (typeof secondsRemaining !== 'undefined') {
                secondsRemaining = 300;
                updateCountdown();
            }

            const maxTokens = parseInt(document.getElementById('max-tokens').value);

            const btn = document.getElementById('start-scan-btn');
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size: 1.25rem;">⏳</span><span>Scan en cours...</span>';

            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-results').style.display = 'none';

            try {
                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        max_tokens: maxTokens
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Poll for results
                    pollScanResults();
                } else {
                    alert('Erreur: ' + (data.error || 'Échec du scan'));
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                alert('Erreur réseau');
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                document.getElementById('scan-progress').style.display = 'none';
            }
        }

        // Poll scan results
        async function pollScanResults() {
            try {
                const response = await fetch('/api/scan/progress');
                const data = await response.json();

                if (data.in_progress) {
                    document.getElementById('scan-status').textContent = data.message || 'Analyse en cours...';
                    setTimeout(pollScanResults, 2000);
                } else {
                    // Scan complete
                    const resultsResponse = await fetch('/api/scan/results');
                    const resultsData = await resultsResponse.json();

                    displayScanResults(resultsData);

                    const btn = document.getElementById('start-scan-btn');
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 1.25rem;">🚀</span><span>Lancer le Scanner IA</span>';
                    document.getElementById('scan-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Error polling:', error);
                setTimeout(pollScanResults, 2000);
            }
        }

        // Load tokens from database on page load
        async function loadTokensFromDatabase() {
            try {
                const response = await fetch('/api/scanned-tokens?limit=50');
                const data = await response.json();

                if (data.success && data.tokens && data.tokens.length > 0) {
                    console.log(`📦 Chargement de ${data.tokens.length} tokens depuis la BDD`);

                    // Transform database format to scan results format
                    const transformedResults = data.tokens.map(token => {
                        const tokenData = token.token_data || {};
                        return {
                            address: token.token_address,
                            chain: token.token_chain,
                            risk_score: token.risk_score || 50,
                            is_safe: token.is_safe,
                            is_pump_dump_suspect: token.is_pump_dump_suspect,
                            ...tokenData  // Merge all token data (market, security, etc.)
                        };
                    });

                    // Count safe/dangerous tokens
                    const safeCount = transformedResults.filter(t => t.is_safe).length;
                    const dangerousCount = transformedResults.length - safeCount;
                    const pumpDumpCount = transformedResults.filter(t => t.is_pump_dump_suspect).length;

                    // Display using existing function
                    displayScanResults({
                        success: true,
                        results: transformedResults,
                        total_analyzed: transformedResults.length,
                        safe_count: safeCount,
                        dangerous_count: dangerousCount,
                        pump_dump_suspects_count: pumpDumpCount
                    });

                    // Show info message
                    const scanResults = document.getElementById('scan-results');
                    const firstChild = scanResults.firstElementChild;
                    if (firstChild) {
                        firstChild.innerHTML = `
                            <h3 style="font-size: 1.75rem; font-weight: 900; margin-bottom: 0.5rem;">💾 Tokens Chargés depuis la Base de Données</h3>
                            <p style="color: var(--text-secondary); font-size: 1.125rem;">
                                ${data.tokens.length} token(s) disponible(s) •
                                <span style="color: #22c55e; font-weight: 600;">${safeCount} sûrs</span> •
                                <span style="color: #ef4444; font-weight: 600;">${dangerousCount} risqués</span> •
                                <span style="color: #f59e0b; font-weight: 600;">${pumpDumpCount} P&D suspects</span>
                            </p>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.5rem;">
                                📊 Cache: ${data.total}/${data.max_capacity} tokens stockés
                            </p>
                        `;
                    }
                } else {
                    console.log('📭 Aucun token en cache, lancez un scan pour commencer');
                }
            } catch (error) {
                console.error('Erreur chargement tokens:', error);
            }
        }

        // Store current tokens globally for AI analysis
        window.currentTokens = [];

        // Update favorite buttons to show current state
        async function updateFavoriteButtons() {
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();

                if (data.success && data.favorites) {
                    data.favorites.forEach(fav => {
                        const btn = document.getElementById(`fav-btn-${fav.token_address}`);
                        if (btn) {
                            btn.style.background = 'rgba(255, 215, 0, 0.3)';
                            btn.style.borderColor = '#ffd700';
                        }
                    });
                }
            } catch (error) {
                console.log('Error loading favorites state:', error);
            }
        }

        // Open token details modal
        function openTokenDetails(tokenIndex) {
            const token = window.currentTokens[tokenIndex];
            if (!token) {
                console.error('Token not found at index:', tokenIndex);
                return;
            }

            const hasMarketData = token.market && !token.market.error;
            const hasSecurity = token.security && !token.security.error;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'token-details-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem; backdrop-filter: blur(10px);';

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 1rem; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
                    <!-- Close button -->
                    <button onclick="document.getElementById('token-details-modal').remove()" style="position: absolute; top: 1rem; right: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem; color: var(--text-secondary); transition: all 0.2s;" onmouseenter="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.borderColor='#ef4444'; this.style.color='#ef4444';" onmouseleave="this.style.background='var(--bg-glass)'; this.style.borderColor='var(--border-subtle)'; this.style.color='var(--text-secondary)';">✕</button>

                    <!-- Header -->
                    <div style="display: flex; gap: 1.5rem; align-items: start; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-subtle);">
                        ${token.icon ? `<img src="${token.icon}" style="width: 80px; height: 80px; border-radius: 1rem;">` : '<div style="width: 80px; height: 80px; border-radius: 1rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">🪙</div>'}
                        <div style="flex: 1;">
                            <h2 style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.5rem;">${token.description || 'Token Details'}</h2>
                            <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem;">${token.address}</div>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <span style="background: var(--bg-glass); padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600;">${token.chain.toUpperCase()}</span>
                                ${token.is_safe ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600;">✅ SAFE</span>' : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600;">⚠️ RISKY</span>'}
                                <span style="background: var(--gradient-primary); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 700;">Risk: ${token.risk_score}/100</span>
                            </div>
                        </div>
                    </div>

                    <!-- Full Details Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        ${hasMarketData ? `
                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">💹 Market Data</h3>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem;">
                                    <div style="display: flex; justify-content: space-between;"><span>Price:</span><span style="font-weight: 700;">$${token.market.price_usd?.toFixed(8) || 'N/A'}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>24h Change:</span><span style="font-weight: 700; color: ${token.market.price_change_24h >= 0 ? '#22c55e' : '#ef4444'};">${(token.market.price_change_24h >= 0 ? '+' : '')}${token.market.price_change_24h?.toFixed(2) || '0'}%</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Liquidity:</span><span style="font-weight: 700;">$${(token.market.liquidity_usd / 1000).toFixed(2)}K</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Volume 24h:</span><span style="font-weight: 700;">$${(token.market.volume_24h / 1000).toFixed(2)}K</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Market Cap:</span><span style="font-weight: 700;">$${(token.market.market_cap / 1000).toFixed(2)}K</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Buys/Sells:</span><span style="font-weight: 700;">${token.market.txns_24h_buys || 0}/${token.market.txns_24h_sells || 0}</span></div>
                                </div>
                            </div>
                        ` : ''}

                        ${hasSecurity ? `
                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">🔒 Security</h3>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem;">
                                    <div style="display: flex; justify-content: space-between;"><span>Buy Tax:</span><span style="font-weight: 700; color: ${token.security.buy_tax > 10 ? '#ef4444' : '#22c55e'};">${token.security.buy_tax?.toFixed(1) || 0}%</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Sell Tax:</span><span style="font-weight: 700; color: ${token.security.sell_tax > 10 ? '#ef4444' : '#22c55e'};">${token.security.sell_tax?.toFixed(1) || 0}%</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Honeypot:</span><span style="font-weight: 700; color: ${token.security.is_honeypot ? '#ef4444' : '#22c55e'};">${token.security.is_honeypot ? '❌ Yes' : '✅ No'}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Mintable:</span><span style="font-weight: 700; color: ${token.security.is_mintable ? '#f59e0b' : '#22c55e'};">${token.security.is_mintable ? '⚠️ Yes' : '✅ No'}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Open Source:</span><span style="font-weight: 700; color: ${token.security.is_open_source ? '#22c55e' : '#f59e0b'};">${token.security.is_open_source ? '✅ Yes' : '⚠️ No'}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span>Holders:</span><span style="font-weight: 700;">${token.security.holder_count || 'N/A'}</span></div>
                                </div>
                            </div>
                        ` : ''}

                        ${token.pump_dump_score ? `
                            <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">🚨 Pump & Dump Risk</h3>
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 3rem; font-weight: 800; background: var(--gradient-danger); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${token.pump_dump_score}/100</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: ${token.pump_dump_risk === 'FAIBLE' ? '#22c55e' : token.pump_dump_risk === 'MOYEN' ? '#f59e0b' : '#ef4444'};">${token.pump_dump_risk}</div>
                                </div>
                                ${token.pump_dump_warnings && token.pump_dump_warnings.length > 0 ? `
                                    <div style="background: rgba(239, 68, 68, 0.1); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.8rem; line-height: 1.5;">
                                        ${token.pump_dump_warnings.slice(0, 5).map(w => `<div style="margin-bottom: 0.5rem;">• ${w}</div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>

                    <!-- All Warnings -->
                    ${token.warnings && token.warnings.length > 0 ? `
                        <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 0.875rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem; text-transform: uppercase;">⚠️ All Warnings</h3>
                            <div style="display: grid; gap: 0.5rem; font-size: 0.875rem; line-height: 1.6;">
                                ${token.warnings.map(w => `<div>• ${w}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <button onclick="analyzeTokenWithAI(${tokenIndex}, this); event.stopPropagation();" style="padding: 1rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            🤖 Analyze with AI
                        </button>
                        ${token.url ? `<a href="${token.url}" target="_blank" style="padding: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">📊 DexScreener</a>` : ''}
                        ${token.website ? `<a href="${token.website}" target="_blank" style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">🌐 Website</a>` : ''}
                        ${token.twitter ? `<a href="${token.twitter}" target="_blank" style="padding: 1rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">🐦 Twitter</a>` : ''}
                        ${token.telegram ? `<a href="${token.telegram}" target="_blank" style="padding: 1rem; background: rgba(34, 197, 233, 0.1); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">✈️ Telegram</a>` : ''}
                        ${token.discord ? `<a href="${token.discord}" target="_blank" style="padding: 1rem; background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; text-align: center; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;">💬 Discord</a>` : ''}
                    </div>
                </div>
            `;

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Display scan results - ENHANCED WITH ALL AVAILABLE DATA
        function displayScanResults(data) {
            const container = document.getElementById('scan-results');
            container.style.display = 'block';

            console.log('📊 Displaying scan results:', data);

            if (data.results && data.results.length > 0) {
                // Store tokens globally
                window.currentTokens = data.results;

                // Build enriched tokens list
                const tokensHTML = data.results.map((token, index) => {
                    const hasMarketData = token.market && !token.market.error;
                    const hasSecurity = token.security && !token.security.error;
                    const hasTwitter = token.twitter_data && !token.twitter_data.error;

                    // Price & changes
                    const price = hasMarketData ? token.market.price_usd : 0;
                    const change24h = hasMarketData ? (token.market.price_change_24h || 0) : 0;
                    const change6h = hasMarketData ? (token.market.price_change_6h || 0) : 0;
                    const change1h = hasMarketData ? (token.market.price_change_1h || 0) : 0;

                    // Market data
                    const liquidity = hasMarketData ? (token.market.liquidity_usd || 0) : 0;
                    const volume24h = hasMarketData ? (token.market.volume_24h || 0) : 0;
                    const volume6h = hasMarketData ? (token.market.volume_6h || 0) : 0;
                    const marketCap = hasMarketData ? (token.market.market_cap || 0) : 0;
                    const buys = hasMarketData ? (token.market.txns_24h_buys || 0) : 0;
                    const sells = hasMarketData ? (token.market.txns_24h_sells || 0) : 0;
                    const pairAge = hasMarketData ? token.market.pair_created_at : 'N/A';

                    // Security data
                    const buyTax = hasSecurity ? (token.security.buy_tax || 0) : 0;
                    const sellTax = hasSecurity ? (token.security.sell_tax || 0) : 0;
                    const holders = hasSecurity ? (token.security.holder_count || 'N/A') : 'N/A';
                    const isHoneypot = hasSecurity ? token.security.is_honeypot : false;
                    const isMintable = hasSecurity ? token.security.is_mintable : false;
                    const isOpenSource = hasSecurity ? token.security.is_open_source : false;

                    // Social data
                    const socialScore = token.social_score || 0;
                    const followers = hasTwitter ? (token.twitter_data.followers || 0) : 0;
                    const tweets = hasTwitter ? (token.twitter_data.tweets || 0) : 0;

                    // Pump & Dump data
                    const pumpScore = token.pump_dump_score || 0;
                    const pumpRisk = token.pump_dump_risk || 'UNKNOWN';

                    // Risk score color
                    const riskColor = token.risk_score < 30 ? '#22c55e' :
                                     token.risk_score < 70 ? '#f59e0b' : '#ef4444';
                    const pumpColor = pumpRisk === 'FAIBLE' ? '#22c55e' :
                                      pumpRisk === 'MOYEN' ? '#f59e0b' : '#ef4444';

                    // Format numbers
                    const formatNumber = (num) => {
                        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                        return num.toFixed(2);
                    };

                    const formatPrice = (p) => {
                        if (p >= 1) return '$' + p.toFixed(4);
                        if (p >= 0.0001) return '$' + p.toFixed(6);
                        return '$' + p.toExponential(2);
                    };

                    const colorChange = (val) => val >= 0 ? '#22c55e' : '#ef4444';
                    const formatChange = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';

                    return `
                        <div onclick="openTokenDetails(${index})" style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; backdrop-filter: blur(20px); transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; cursor: pointer;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.15)'; this.style.borderColor='var(--accent-primary)';" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'; this.style.borderColor='var(--border-subtle)';">

                            <!-- Compact Header -->
                            <div style="display: flex; gap: 0.75rem; align-items: start; margin-bottom: 0.75rem;">
                                <!-- Icon + Favorite -->
                                <div style="position: relative;">
                                    ${token.icon ? `
                                        <img src="${token.icon}" alt="${token.description || 'Token'}" style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--bg-glass); padding: 0.25rem;" onerror="this.style.display='none'">
                                    ` : `
                                        <div style="width: 48px; height: 48px; border-radius: 0.5rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🪙</div>
                                    `}
                                    <button onclick="event.stopPropagation(); toggleFavorite('${token.address}', '${token.chain}', ${index});" id="fav-btn-${token.address}" style="position: absolute; top: -6px; right: -6px; background: rgba(0, 0, 0, 0.7); border: 1px solid var(--border-subtle); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; transition: all 0.2s; z-index: 10; display: flex; align-items: center; justify-content: center; padding: 0;" onmouseenter="this.style.transform='scale(1.15)'; this.style.background='rgba(255, 215, 0, 0.3)'; this.style.borderColor='#ffd700';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(0, 0, 0, 0.7)'; this.style.borderColor='var(--border-subtle)';">
                                        <span style="font-size: 0.75rem;">⭐</span>
                                    </button>
                                </div>

                                <!-- Title + Badges -->
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${token.description || 'Token ' + (index + 1)}
                                    </h4>
                                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.4rem;">
                                        ${token.address.substring(0, 8)}...${token.address.substring(token.address.length - 6)}
                                    </div>
                                    <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                        <span style="background: var(--bg-glass); padding: 0.15rem 0.5rem; border-radius: 0.75rem; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">
                                            ${token.chain}
                                        </span>
                                        ${token.is_safe ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.15rem 0.5rem; border-radius: 0.75rem; font-size: 0.7rem; font-weight: 600;">✅ SAFE</span>' : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.15rem 0.5rem; border-radius: 0.75rem; font-size: 0.7rem; font-weight: 600;">⚠️ RISKY</span>'}
                                        ${token.is_pump_dump_suspect ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.15rem 0.5rem; border-radius: 0.75rem; font-size: 0.7rem; font-weight: 600;">🚨 P&D</span>' : ''}
                                    </div>
                                </div>

                                <!-- Risk Score + Price -->
                                <div style="text-align: right;">
                                    <div style="background: ${riskColor}; color: white; padding: 0.4rem 0.75rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.875rem; margin-bottom: 0.35rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: nowrap;">
                                        ${token.risk_score}
                                    </div>
                                    ${hasMarketData ? `
                                        <div style="font-size: 1rem; font-weight: 700; margin-bottom: 0.15rem;">
                                            ${formatPrice(price)}
                                        </div>
                                        <div style="color: ${colorChange(change24h)}; font-weight: 600; font-size: 0.75rem;">
                                            ${formatChange(change24h)}
                                        </div>
                                    ` : '<div style="color: var(--text-tertiary); font-size: 0.7rem;">No data</div>'}
                                </div>
                            </div>

                            <!-- Quick Stats (2x4 Grid) -->
                            ${hasMarketData ? `
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💧 Liq</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(liquidity)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">📊 Vol</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(volume24h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">💎 MCap</div>
                                        <div style="font-weight: 700; font-size: 0.75rem;">$${formatNumber(marketCap)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">⏰ Age</div>
                                        <div style="font-weight: 700; font-size: 0.7rem;">${pairAge !== 'N/A' ? Math.floor((Date.now() - pairAge * 1000) / (1000 * 60 * 60)) + 'h' : 'N/A'}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">1H</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change1h)};">${formatChange(change1h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">6H</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: ${colorChange(change6h)};">${formatChange(change6h)}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🟢 Buys</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: #22c55e;">${buys}</div>
                                    </div>
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 0.15rem;">🔴 Sells</div>
                                        <div style="font-weight: 700; font-size: 0.75rem; color: #ef4444;">${sells}</div>
                                    </div>
                                </div>
                            ` : `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="color: #ef4444; font-weight: 600; font-size: 0.75rem; text-align: center;">
                                        ⚠️ Market data unavailable
                                    </div>
                                </div>
                            `}

                            <!-- Compact Security + P&D Row -->
                            <div style="display: grid; grid-template-columns: ${hasSecurity && hasTwitter ? 'repeat(3, 1fr)' : hasSecurity || hasTwitter ? 'repeat(2, 1fr)' : '1fr'}; gap: 0.5rem; margin-bottom: 0.75rem;">
                                ${hasSecurity ? `
                                    <div style="background: var(--bg-glass); border-radius: 0.5rem; padding: 0.75rem;">
                                        <div style="font-size: 0.7rem; color: var(--text-tertiary); margin-bottom: 0.4rem; font-weight: 600;">🔒 SECURITY</div>
                                        <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.7rem;">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>Tax:</span>
                                                <span style="font-weight: 600; color: ${(buyTax + sellTax) > 15 ? '#ef4444' : '#22c55e'};">${buyTax.toFixed(1)}%/${sellTax.toFixed(1)}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>HP:</span>
                                                <span style="font-weight: 600; color: ${isHoneypot ? '#ef4444' : '#22c55e'};">${isHoneypot ? '❌' : '✅'}</span>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${hasTwitter ? `
                                    <div style="background: linear-gradient(135deg, rgba(29, 161, 242, 0.1) 0%, rgba(29, 161, 242, 0.05) 100%); border: 1px solid rgba(29, 161, 242, 0.2); border-radius: 0.5rem; padding: 0.75rem;">
                                        <div style="font-size: 0.7rem; color: #1da1f2; margin-bottom: 0.3rem; font-weight: 600;">🐦 SOCIAL</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #1da1f2;">${socialScore}/100</div>
                                        <div style="font-size: 0.65rem; color: var(--text-tertiary);">${formatNumber(followers)} followers</div>
                                    </div>
                                ` : ''}
                                <div style="background: linear-gradient(135deg, ${pumpColor}15 0%, ${pumpColor}08 100%); border: 1px solid ${pumpColor}66; border-radius: 0.5rem; padding: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: ${pumpColor}; margin-bottom: 0.3rem; font-weight: 600;">🚨 P&D RISK</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: ${pumpColor};">${pumpScore}/100</div>
                                    <div style="font-size: 0.65rem; font-weight: 600; color: ${pumpColor};">${pumpRisk}</div>
                                </div>
                            </div>

                            <!-- Compact Warnings -->
                            ${(token.warnings && token.warnings.length > 0) || (token.pump_dump_warnings && token.pump_dump_warnings.length > 0) ? `
                                <div style="background: rgba(239, 68, 68, 0.08); border-left: 3px solid #ef4444; border-radius: 0.5rem; padding: 0.6rem 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-weight: 600; font-size: 0.75rem; color: #ef4444; margin-bottom: 0.4rem;">⚠️ WARNINGS</div>
                                    <div style="font-size: 0.7rem; color: var(--text-secondary); line-height: 1.4;">
                                        ${(() => {
                                            const allWarnings = [...(token.warnings || []), ...(token.pump_dump_warnings || [])];
                                            const displayWarnings = allWarnings.slice(0, 3).map(w => `• ${w}`).join(' ');
                                            const moreCount = allWarnings.length > 3 ? ` <span style="color: #f59e0b;">+${allWarnings.length - 3} more</span>` : '';
                                            return displayWarnings + moreCount;
                                        })()}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Compact Action Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                                <button onclick="event.stopPropagation(); analyzeTokenWithAI(${index}, this);" style="padding: 0.6rem 0.75rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3); font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)';" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                                    <span>🤖</span>
                                    <span>AI</span>
                                </button>
                                ${token.url ? `
                                    <a href="${token.url}" target="_blank" style="padding: 0.6rem 0.75rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.borderColor='var(--accent-primary)';" onmouseleave="this.style.transform='scale(1)'; this.style.borderColor='var(--border-subtle)';">
                                        <span>📊</span>
                                        <span>Dex</span>
                                    </a>
                                ` : ''}
                                ${token.twitter ? `
                                    <a href="${token.twitter}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); color: #1da1f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(29, 161, 242, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(29, 161, 242, 0.1)';">
                                        <span>🐦</span>
                                        <span>X</span>
                                    </a>
                                ` : ''}
                                ${token.website ? `
                                    <a href="${token.website}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(139, 92, 246, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(139, 92, 246, 0.1)';">
                                        <span>🌐</span>
                                        <span>Web</span>
                                    </a>
                                ` : ''}
                                ${token.telegram ? `
                                    <a href="${token.telegram}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(34, 197, 233, 0.1); border: 1px solid rgba(34, 197, 233, 0.3); color: #22c5e9; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(34, 197, 233, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(34, 197, 233, 0.1)';">
                                        <span>✈️</span>
                                        <span>TG</span>
                                    </a>
                                ` : ''}
                                ${token.discord ? `
                                    <a href="${token.discord}" target="_blank" style="padding: 0.6rem 0.75rem; background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); color: #5865f2; text-decoration: none; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.4rem; transition: all 0.2s; font-size: 0.8rem;" onmouseenter="this.style.transform='scale(1.03)'; this.style.background='rgba(88, 101, 242, 0.2)';" onmouseleave="this.style.transform='scale(1)'; this.style.background='rgba(88, 101, 242, 0.1)';">
                                        <span>💬</span>
                                        <span>DC</span>
                                    </a>
                                ` : ''}
                            </div>

                            <!-- AI Analysis Result -->
                            <div id="ai-result-${token.address}" style="display: none; margin-top: 1.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                    <span style="font-size: 1.5rem;">🤖</span>
                                    <h5 style="font-weight: 700; font-size: 1.125rem;">Analyse Claude IA</h5>
                                </div>
                                <div id="ai-content-${token.address}" style="color: var(--text-secondary); line-height: 1.8; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid var(--accent-primary); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; text-align: center;">
                        <h3 style="font-size: 1.75rem; font-weight: 900; margin-bottom: 0.5rem;">✅ Scan Terminé !</h3>
                        <p style="color: var(--text-secondary); font-size: 1.125rem;">
                            ${data.results.length} token(s) analysé(s) •
                            <span style="color: #22c55e; font-weight: 600;">${data.safe_count || 0} sûrs</span> •
                            <span style="color: #ef4444; font-weight: 600;">${data.dangerous_count || 0} risqués</span> •
                            <span style="color: #f59e0b; font-weight: 600;">${data.pump_dump_suspects_count || 0} P&D suspects</span>
                        </p>
                        <p style="color: var(--accent-success); font-size: 0.875rem; margin-top: 0.5rem;">
                            💾 Tokens sauvegardés en base de données
                        </p>
                    </div>
                    ${tokensHTML}
                `;

                // Refresh stats
                loadUserInfo();

                // Update favorite buttons state
                updateFavoriteButtons();
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🤷</div>
                        <p>Aucun token trouvé</p>
                    </div>
                `;
            }
        }

        // AI Token Analysis
        async function analyzeTokenWithAI(tokenIndex, buttonElement) {
            // Get token data from global array
            const tokenData = window.currentTokens[tokenIndex];
            if (!tokenData) {
                console.error('Token not found at index:', tokenIndex);
                return;
            }

            const address = tokenData.address;
            const chain = tokenData.chain;
            const resultDiv = document.getElementById(`ai-result-${address}`);
            const contentDiv = document.getElementById(`ai-content-${address}`);

            // Show loading state
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span>⏳</span><span>Analyse en cours...</span>';
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><div style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 0.5rem;">Claude analyse le token...</p></div>';

            try {
                const response = await fetch('/api/analyze-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        chain: chain,
                        token_data: tokenData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    contentDiv.innerHTML = data.analysis || 'Analyse terminée.';
                } else {
                    contentDiv.innerHTML = `<div style="color: #ef4444;">❌ Erreur: ${data.error || 'Impossible d\'analyser le token'}</div>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: #ef4444;">❌ Erreur de connexion: ${error.message}</div>`;
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<span>🤖</span><span>Scan par IA</span>';
            }
        }

        // ==================== AUTO-SCAN SYSTEM ====================
        let autoScanInterval = null;
        let countdownInterval = null;
        let secondsRemaining = 300; // 5 minutes = 300 seconds

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateCountdown() {
            const timerElement = document.getElementById('countdown-timer');
            if (timerElement) {
                timerElement.textContent = formatTime(secondsRemaining);

                // Color change based on time remaining
                if (secondsRemaining <= 30) {
                    timerElement.style.color = '#ef4444'; // Red when <30s
                } else if (secondsRemaining <= 60) {
                    timerElement.style.color = '#f59e0b'; // Orange when <1min
                } else {
                    timerElement.style.color = 'var(--accent-primary)'; // Normal
                }
            }

            secondsRemaining--;

            if (secondsRemaining < 0) {
                // Time's up! Trigger auto-scan
                secondsRemaining = 300; // Reset to 5 minutes
                triggerAutoScan();
            }
        }

        async function triggerAutoScan() {
            console.log('🤖 Auto-scan triggered!');

            // Check if already scanning
            const btn = document.getElementById('start-scan-btn');
            if (btn.disabled) {
                console.log('⏸️ Scan already in progress, skipping auto-scan');
                return;
            }

            // Trigger scan with notification
            const countdownDiv = document.getElementById('auto-scan-countdown');
            const originalHTML = countdownDiv.innerHTML;

            // Show auto-scan message
            countdownDiv.innerHTML = `
                <span>🤖</span>
                <span>Scan automatique en cours...</span>
            `;
            countdownDiv.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2))';
            countdownDiv.style.borderColor = 'var(--accent-primary)';

            // Start scan
            await startScan();

            // Wait a bit before resetting display
            setTimeout(() => {
                countdownDiv.innerHTML = originalHTML;
                countdownDiv.style.background = 'var(--bg-glass)';
                countdownDiv.style.borderColor = '';
            }, 3000);
        }

        function startAutoScanSystem() {
            console.log('🚀 Auto-scan system initialized (5-minute intervals)');

            // Start countdown
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdown, 1000);

            // Initial countdown display
            updateCountdown();
        }

        function stopAutoScanSystem() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            console.log('⏹️ Auto-scan system stopped');
        }

        // ==================== CRYPTO NEWS ====================
        async function loadCryptoNews(forceRefresh = false) {
            const newsList = document.getElementById('news-list');
            const cacheInfo = document.getElementById('news-cache-info');

            try {
                const url = `/api/news/crypto?limit=10&force_refresh=${forceRefresh}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.articles) {
                    // Display cache info
                    if (data.cached) {
                        const expiresMin = Math.floor(data.cache_expires_in / 60);
                        cacheInfo.textContent = `✅ Cache actif - Expire dans ${expiresMin} minutes`;
                        cacheInfo.style.color = 'var(--accent-success)';
                    } else {
                        cacheInfo.textContent = `🆕 Actualités fraîches - Cache valide 30 minutes`;
                        cacheInfo.style.color = 'var(--accent-primary)';
                    }

                    // Display articles
                    newsList.innerHTML = data.articles.map((article, index) => `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s; cursor: pointer;" onmouseenter="this.style.borderColor='var(--accent-primary)'" onmouseleave="this.style.borderColor='var(--border-subtle)'" onclick="window.open('${article.url}', '_blank')">
                            <div style="display: flex; gap: 1rem;">
                                ${article.image_url ? `
                                    <img src="${article.image_url}" style="width: 80px; height: 80px; border-radius: 0.5rem; object-fit: cover;" onerror="this.style.display='none'">
                                ` : ''}
                                <div style="flex: 1;">
                                    <h4 style="font-size: 0.95rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">${article.title}</h4>
                                    <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                        <span>📅 ${article.published_date}</span>
                                        <span>📰 ${article.source}</span>
                                        ${article.sentiment !== 'NEUTRAL' ? `<span style="color: ${article.sentiment === 'POSITIVE' ? '#22c55e' : '#ef4444'};">● ${article.sentiment}</span>` : ''}
                                    </div>
                                    ${article.categories.length > 0 ? `
                                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">
                                            ${article.categories.slice(0, 3).map(cat => `<span style="background: var(--bg-glass); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.65rem; color: var(--text-secondary);">${cat}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    console.log(`✅ Loaded ${data.articles.length} news articles`);
                } else {
                    newsList.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">📭</div><p>Aucune actualité disponible</p></div>`;
                }
            } catch (error) {
                console.error('Error loading news:', error);
                newsList.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--accent-danger);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">❌</div><p>Erreur de chargement des actualités</p></div>`;
            }
        }

        async function refreshNews() {
            const refreshIcon = document.getElementById('news-refresh-icon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            await loadCryptoNews(true);
            setTimeout(() => {
                refreshIcon.style.animation = 'none';
            }, 1000);
        }

        // ==================== TOKEN SEARCH ====================
        async function searchToken() {
            const input = document.getElementById('token-search-input');
            const resultsDiv = document.getElementById('token-search-results');
            const query = input.value.trim();

            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            // Show loading
            resultsDiv.innerHTML = `<div class="loading" style="text-align: center; padding: 1rem;"><div class="spinner" style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>`;

            try {
                const response = await fetch(`/api/token/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success && data.tokens && data.tokens.length > 0) {
                    resultsDiv.innerHTML = data.tokens.map(token => `
                        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.25rem; margin-top: 1rem;">
                            <div style="display: flex; gap: 1rem; align-items: start; margin-bottom: 1rem;">
                                ${token.logo ? `<img src="${token.logo}" style="width: 56px; height: 56px; border-radius: 0.75rem;">` : '<div style="width: 56px; height: 56px; border-radius: 0.75rem; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">🪙</div>'}
                                <div style="flex: 1;">
                                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">${token.name} <span style="color: var(--text-secondary); font-weight: 600;">(${token.symbol})</span></h3>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">
                                        ${token.category ? `<span style="background: var(--bg-glass); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; text-transform: uppercase; margin-right: 0.5rem;">${token.category}</span>` : ''}
                                        ${token.date_launched ? `Lancé: ${new Date(token.date_launched).toLocaleDateString('fr-FR')}` : ''}
                                    </div>
                                    ${token.tags && token.tags.length > 0 ? `
                                        <div style="display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                                            ${token.tags.slice(0, 5).map(tag => `<span style="background: rgba(102, 126, 234, 0.1); color: var(--accent-primary); padding: 0.15rem 0.5rem; border-radius: 0.5rem; font-size: 0.7rem;">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            ${token.description ? `<p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">${token.description.substring(0, 300)}${token.description.length > 300 ? '...' : ''}</p>` : ''}

                            ${token.urls ? `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem;">
                                    ${token.urls.website && token.urls.website.length > 0 ? `<a href="${token.urls.website[0]}" target="_blank" style="padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🌐 Website</a>` : ''}
                                    ${token.urls.twitter && token.urls.twitter.length > 0 ? `<a href="${token.urls.twitter[0]}" target="_blank" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">𝕏 Twitter</a>` : ''}
                                    ${token.urls.reddit && token.urls.reddit.length > 0 ? `<a href="${token.urls.reddit[0]}" target="_blank" style="padding: 0.5rem; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); color: #f97316; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🔶 Reddit</a>` : ''}
                                    ${token.urls.explorer && token.urls.explorer.length > 0 ? `<a href="${token.urls.explorer[0]}" target="_blank" style="padding: 0.5rem; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">🔍 Explorer</a>` : ''}
                                    ${token.urls.source_code && token.urls.source_code.length > 0 ? `<a href="${token.urls.source_code[0]}" target="_blank" style="padding: 0.5rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-secondary); text-decoration: none; border-radius: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600;">💻 Code</a>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    console.log(`✅ Found ${data.tokens.length} token(s)`);
                } else {
                    resultsDiv.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">🔍</div><p>Aucun token trouvé pour "${query}"</p><p style="font-size: 0.8rem; margin-top: 0.5rem;">Essayez avec un symbole (BTC, ETH) ou nom complet (bitcoin, ethereum)</p></div>`;
                }
            } catch (error) {
                console.error('Error searching token:', error);
                resultsDiv.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--accent-danger);"><div style="font-size: 3rem; margin-bottom: 0.5rem;">❌</div><p>Erreur de recherche</p></div>`;
            }
        }

        // Initialize
        loadUserInfo();
        loadTokensFromDatabase();  // Load tokens from database on page load
        loadCryptoNews();  // Load crypto news on page load
        startAutoScanSystem();

        // Auto-refresh tokens from database every 5 minutes (sync with auto-scan)
        setInterval(() => {
            console.log('🔄 Auto-refreshing tokens from database...');
            loadTokensFromDatabase();
        }, 5 * 60 * 1000);  // 5 minutes

        // Stop auto-scan when user leaves page
        window.addEventListener('beforeunload', () => {
            stopAutoScanSystem();
        });
    </script>

    <!-- Auth Modal (Login/Register) -->
    {% include 'components_auth_modal.html' %}
</body>
</html>
