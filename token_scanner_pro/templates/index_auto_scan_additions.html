<!-- 
========================================
AJOUTS √Ä INT√âGRER DANS templates/index.html
Ajouter APR√àS la section "System Health Bar" et AVANT le header principal
========================================
-->

<!-- üÜï AUTO-SCAN PANEL -->
<div class="auto-scan-banner" id="autoScanBanner">
    <div class="banner-content">
        <div class="banner-left">
            <span class="banner-icon">ü§ñ</span>
            <div class="banner-info">
                <strong>Scan Automatique Actif</strong>
                <span class="banner-subtext" id="autoScanStatus">Prochain scan dans...</span>
            </div>
        </div>
        <div class="banner-right">
            <div class="banner-stats">
                <div class="banner-stat">
                    <span class="stat-value" id="cachedTokensCount">0</span>
                    <span class="stat-label">Tokens en cache</span>
                </div>
                <div class="banner-stat">
                    <span class="stat-value" id="lastScanTime">--:--</span>
                    <span class="stat-label">Dernier scan</span>
                </div>
            </div>
            <button class="btn btn-outline btn-small" onclick="viewCachedTokens()" title="Voir les tokens du cache">
                üì¶ Cache (24h)
            </button>
        </div>
    </div>
</div>

<!-- 
========================================
STYLES CSS √Ä AJOUTER DANS LA BALISE <style> EXISTANTE
========================================
-->
<style>
/* Auto-Scan Banner */
.auto-scan-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 12px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: none; /* Cach√© par d√©faut, affich√© quand actif */
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.banner-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1400px;
    margin: 0 auto;
}

.banner-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.banner-icon {
    font-size: 24px;
    animation: pulse 2s infinite;
}

.banner-info {
    display: flex;
    flex-direction: column;
}

.banner-info strong {
    font-size: 14px;
    font-weight: 600;
}

.banner-subtext {
    font-size: 12px;
    opacity: 0.9;
}

.banner-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.banner-stats {
    display: flex;
    gap: 24px;
}

.banner-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.banner-stat .stat-value {
    font-size: 20px;
    font-weight: 700;
}

.banner-stat .stat-label {
    font-size: 11px;
    opacity: 0.9;
    text-transform: uppercase;
}

/* Modal Cache Tokens */
.cache-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.cache-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.cache-modal-content {
    background: var(--bg-secondary);
    border-radius: 24px;
    width: 90%;
    max-width: 1200px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.cache-modal-header {
    padding: 24px 32px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cache-modal-title {
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
}

.cache-filters {
    padding: 16px 32px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.cache-modal-body {
    padding: 24px 32px;
    overflow-y: auto;
    flex: 1;
}

.cache-stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.cache-stat-card {
    background: var(--bg-card);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.cache-stat-card .value {
    font-size: 28px;
    font-weight: 700;
    display: block;
    margin-bottom: 4px;
}

.cache-stat-card .label {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Token age badge */
.token-age {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(102, 126, 234, 0.1);
    color: var(--accent-blue);
    margin-left: 8px;
}

.token-age.fresh {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-green);
}

.token-age.old {
    background: rgba(249, 115, 22, 0.1);
    color: var(--accent-orange);
}
</style>

<!-- 
========================================
JAVASCRIPT √Ä AJOUTER √Ä LA FIN DU <script> EXISTANT
========================================
-->
<script>
// ==================== AUTO-SCAN MANAGEMENT ====================

let autoScanInterval = null;
let cacheUpdateInterval = null;

// V√©rifier le statut du scan auto au chargement
async function checkAutoScanStatus() {
    try {
        const response = await fetch(`${API_URL}/auto-scan/status`);
        const data = await response.json();
        
        if (data.success && data.status.is_running) {
            updateAutoScanBanner(data.status);
            document.getElementById('autoScanBanner').style.display = 'block';
        } else {
            document.getElementById('autoScanBanner').style.display = 'none';
        }
    } catch (error) {
        console.log('Auto-scan non actif');
    }
}

// Mettre √† jour le banner
function updateAutoScanBanner(status) {
    const nextScanIn = status.next_scan_in;
    const cacheStats = status.cache_stats;
    
    // Prochain scan
    if (nextScanIn !== null) {
        const minutes = Math.floor(nextScanIn / 60);
        const seconds = nextScanIn % 60;
        document.getElementById('autoScanStatus').textContent = 
            `Prochain scan dans ${minutes}m ${seconds}s`;
    }
    
    // Tokens en cache
    if (cacheStats) {
        document.getElementById('cachedTokensCount').textContent = 
            cacheStats.total_tokens || 0;
    }
    
    // Dernier scan
    if (status.last_scan_time) {
        const date = new Date(status.last_scan_time);
        document.getElementById('lastScanTime').textContent = 
            date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }
}

// Voir les tokens en cache
async function viewCachedTokens() {
    try {
        const response = await fetch(`${API_URL}/auto-scan/tokens/recent?limit=100`);
        const data = await response.json();
        
        if (data.success) {
            showCacheModal(data.tokens, data.count);
        } else {
            showToast('Impossible de charger le cache', 'error');
        }
    } catch (error) {
        showToast('Erreur lors du chargement', 'error');
    }
}

// Afficher le modal du cache
function showCacheModal(tokens, totalCount) {
    // Cr√©er le modal s'il n'existe pas
    let modal = document.getElementById('cacheModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'cacheModal';
        modal.className = 'cache-modal';
        modal.innerHTML = `
            <div class="cache-modal-content">
                <div class="cache-modal-header">
                    <h2 class="cache-modal-title">
                        üì¶ Tokens en Cache (24h)
                    </h2>
                    <button class="modal-close" onclick="closeCacheModal()">‚úï</button>
                </div>
                <div class="cache-filters">
                    <button class="filter-btn active" onclick="filterCache('all')">Tous</button>
                    <button class="filter-btn" onclick="filterCache('safe')">‚úÖ S√ªrs</button>
                    <button class="filter-btn" onclick="filterCache('danger')">‚ö†Ô∏è Risqu√©s</button>
                    <button class="filter-btn" onclick="filterCache('fresh')">üî• R√©cents (<1h)</button>
                </div>
                <div class="cache-modal-body">
                    <div class="cache-stats-row" id="cacheStatsRow"></div>
                    <div class="tokens-grid" id="cacheTokensGrid"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Calculer les stats
    const safeCount = tokens.filter(t => t.is_safe).length;
    const dangerCount = totalCount - safeCount;
    const now = Date.now();
    const freshCount = tokens.filter(t => {
        const age = (now - new Date(t.created_at || 0).getTime()) / 1000 / 3600;
        return age < 1;
    }).length;
    
    // Afficher les stats
    document.getElementById('cacheStatsRow').innerHTML = `
        <div class="cache-stat-card">
            <span class="value">${totalCount}</span>
            <span class="label">Total</span>
        </div>
        <div class="cache-stat-card">
            <span class="value" style="color: var(--accent-green)">${safeCount}</span>
            <span class="label">S√ªrs</span>
        </div>
        <div class="cache-stat-card">
            <span class="value" style="color: var(--accent-red)">${dangerCount}</span>
            <span class="label">Risqu√©s</span>
        </div>
        <div class="cache-stat-card">
            <span class="value" style="color: var(--accent-orange)">${freshCount}</span>
            <span class="label">R√©cents</span>
        </div>
    `;
    
    // Afficher les tokens
    displayCachedTokens(tokens);
    
    // Afficher le modal
    modal.classList.add('active');
}

// Afficher les tokens du cache
function displayCachedTokens(tokens) {
    const grid = document.getElementById('cacheTokensGrid');
    
    if (tokens.length === 0) {
        grid.innerHTML = '<div class="empty-state"><p>Aucun token dans le cache</p></div>';
        return;
    }
    
    // R√©utiliser la fonction existante displayTokens mais dans le grid du cache
    grid.innerHTML = '';
    tokens.forEach(token => {
        const card = createTokenCard(token);
        
        // Ajouter le badge d'√¢ge
        const now = Date.now();
        const created = new Date(token.created_at || 0).getTime();
        const ageHours = (now - created) / 1000 / 3600;
        
        let ageBadge = '';
        if (ageHours < 1) {
            ageBadge = '<span class="token-age fresh">üî• < 1h</span>';
        } else if (ageHours < 6) {
            ageBadge = `<span class="token-age">${Math.floor(ageHours)}h</span>`;
        } else {
            ageBadge = `<span class="token-age old">${Math.floor(ageHours)}h</span>`;
        }
        
        // Ajouter le badge au header de la carte
        const header = card.querySelector('.token-header');
        if (header) {
            header.innerHTML += ageBadge;
        }
        
        grid.appendChild(card);
    });
}

// Fermer le modal cache
function closeCacheModal() {
    const modal = document.getElementById('cacheModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Filtrer les tokens du cache
async function filterCache(filter) {
    try {
        let url = `${API_URL}/auto-scan/tokens/recent?limit=100`;
        
        if (filter === 'safe') {
            url += '&is_safe=true';
        } else if (filter === 'danger') {
            url += '&is_safe=false';
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            let filtered = data.tokens;
            
            // Filtre "fresh" c√¥t√© client
            if (filter === 'fresh') {
                const now = Date.now();
                filtered = data.tokens.filter(t => {
                    const age = (now - new Date(t.created_at || 0).getTime()) / 1000 / 3600;
                    return age < 1;
                });
            }
            
            displayCachedTokens(filtered);
        }
        
        // Mettre √† jour les boutons de filtre
        document.querySelectorAll('.cache-filters .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
    } catch (error) {
        console.error('Erreur filtre cache:', error);
    }
}

// D√©marrer les mises √† jour p√©riodiques
function startAutoScanUpdates() {
    // V√©rifier le statut toutes les 5 secondes
    autoScanInterval = setInterval(checkAutoScanStatus, 5000);
    
    // V√©rifier imm√©diatement
    checkAutoScanStatus();
}

// Arr√™ter les mises √† jour
function stopAutoScanUpdates() {
    if (autoScanInterval) {
        clearInterval(autoScanInterval);
    }
}

// INITIALISER AU CHARGEMENT
window.addEventListener('load', () => {
    startAutoScanUpdates();
    
    // Ajouter le bouton "Cache" dans la section des filtres existante
    const filtersDiv = document.querySelector('.filters');
    if (filtersDiv) {
        const cacheBtn = document.createElement('button');
        cacheBtn.className = 'filter-btn';
        cacheBtn.innerHTML = 'üì¶ Cache 24h';
        cacheBtn.onclick = viewCachedTokens;
        filtersDiv.appendChild(cacheBtn);
    }
});

// NETTOYER √Ä LA FERMETURE
window.addEventListener('beforeunload', () => {
    stopAutoScanUpdates();
});

// ü§ñ INT√âGRATION AVEC CLAUDE AI INSIGHTS
// Modifier la fonction existante detectAIOpportunities pour inclure les tokens du cache
const originalDetectAIOpportunities = window.detectAIOpportunities || function() {};
window.detectAIOpportunities = async function(tokens) {
    // Appeler la fonction originale
    originalDetectAIOpportunities(tokens);
    
    // Ajouter une suggestion si le cache est actif
    try {
        const response = await fetch(`${API_URL}/auto-scan/status`);
        const data = await response.json();
        
        if (data.success && data.status.is_running) {
            const aiCard = document.getElementById('aiInsightsCard');
            if (aiCard) {
                const content = document.getElementById('aiInsightsContent');
                const currentHTML = content.innerHTML;
                
                content.innerHTML = currentHTML + `
                    <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <strong>üí° Conseil IA:</strong> Le scan automatique est actif. 
                        <a href="#" onclick="viewCachedTokens(); return false;" 
                           style="color: var(--accent-blue); text-decoration: underline;">
                            Consultez le cache de 24h
                        </a> pour plus d'opportunit√©s.
                    </p>
                `;
            }
        }
    } catch (error) {
        // Ignorer silencieusement
    }
};
</script>