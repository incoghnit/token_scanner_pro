"""
Modal de D√©tails Token avec Analyse IA
Composant r√©utilisable pour afficher les d√©tails d'un token avec validation Claude
"""

<!-- Modal Token Details -->
<div id="token-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; overflow-y: auto;">
    <div style="max-width: 900px; margin: 2rem auto; background: var(--bg-card); border-radius: 1rem; padding: 0; position: relative;">
        <!-- Close Button -->
        <button onclick="closeTokenModal()" style="position: absolute; top: 1rem; right: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.5rem; padding: 0.5rem 1rem; color: var(--text-primary); cursor: pointer; font-size: 1.5rem; z-index: 10;">
            ‚úï
        </button>

        <!-- Header -->
        <div style="background: var(--gradient-primary); padding: 2rem; border-radius: 1rem 1rem 0 0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="modal-token-icon" style="width: 64px; height: 64px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <span style="font-size: 2rem;">ü™ô</span>
                </div>
                <div style="flex: 1;">
                    <h2 id="modal-token-name" style="font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; color: white;">Token Name</h2>
                    <div id="modal-token-address" style="font-family: monospace; font-size: 0.875rem; color: rgba(255,255,255,0.8);"></div>
                </div>
                <div id="modal-risk-badge" style="padding: 0.75rem 1.5rem; border-radius: 2rem; font-weight: 700; font-size: 1.25rem; background: white; color: #000;">
                    Risk: 0
                </div>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 2rem;">
            <!-- Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Blockchain</div>
                    <div id="modal-chain" style="font-size: 1.25rem; font-weight: 700; text-transform: uppercase;"></div>
                </div>
                <div style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Liquidit√©</div>
                    <div id="modal-liquidity" style="font-size: 1.25rem; font-weight: 700;"></div>
                </div>
                <div style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Prix 24h</div>
                    <div id="modal-price-change" style="font-size: 1.25rem; font-weight: 700;"></div>
                </div>
                <div style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">P&D Score</div>
                    <div id="modal-pump-dump" style="font-size: 1.25rem; font-weight: 700;"></div>
                </div>
            </div>

            <!-- Warnings -->
            <div id="modal-warnings" style="margin-bottom: 2rem;"></div>

            <!-- Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <button onclick="analyzeWithClaude()" id="claude-analyze-btn" style="padding: 1rem; background: var(--gradient-primary); color: white; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span>ü§ñ</span>
                    <span>Analyser avec Claude IA</span>
                </button>
                <button onclick="addToFavorites()" id="favorite-btn" style="padding: 1rem; background: var(--bg-glass); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span>‚≠ê</span>
                    <span>Ajouter aux Favoris</span>
                </button>
            </div>

            <!-- Claude Analysis Result -->
            <div id="claude-analysis" style="display: none; background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">ü§ñ</span>
                    <h3 style="font-size: 1.25rem; font-weight: 700;">Analyse Claude IA</h3>
                </div>
                <div id="claude-result" style="color: var(--text-secondary); line-height: 1.8; white-space: pre-wrap;"></div>
            </div>

            <!-- Loading State -->
            <div id="claude-loading" style="display: none; text-align: center; padding: 2rem;">
                <div style="border: 3px solid var(--bg-glass); border-top: 3px solid var(--accent-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Analyse en cours par Claude...</p>
            </div>

            <!-- Details -->
            <div style="background: var(--bg-glass); border: 1px solid var(--border-subtle); border-radius: 0.75rem; padding: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">D√©tails Techniques</h3>
                <div id="modal-details" style="display: grid; gap: 0.75rem; font-size: 0.875rem;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
let currentToken = null;

// Open token modal
function openTokenModal(token) {
    currentToken = token;

    // Update header
    document.getElementById('modal-token-name').textContent = token.name || token.chain.toUpperCase();
    document.getElementById('modal-token-address').textContent = token.address;

    // Update icon
    const iconContainer = document.getElementById('modal-token-icon');
    if (token.icon) {
        iconContainer.innerHTML = `<img src="${token.icon}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.innerHTML='ü™ô'">`;
    } else {
        iconContainer.innerHTML = '<span style="font-size: 2rem;">ü™ô</span>';
    }

    // Update risk badge
    const riskScore = token.risk_score || 0;
    const riskBadge = document.getElementById('modal-risk-badge');
    riskBadge.textContent = `Risk: ${riskScore}`;
    if (riskScore < 30) {
        riskBadge.style.background = 'var(--gradient-success)';
        riskBadge.style.color = 'white';
    } else if (riskScore < 70) {
        riskBadge.style.background = 'var(--gradient-warning)';
        riskBadge.style.color = '#000';
    } else {
        riskBadge.style.background = 'var(--gradient-danger)';
        riskBadge.style.color = 'white';
    }

    // Update stats
    document.getElementById('modal-chain').textContent = token.chain.toUpperCase();

    const liquidity = token.market?.liquidity_usd || token.market_data?.liquidity_usd || 0;
    document.getElementById('modal-liquidity').textContent = liquidity > 0 ? `$${(liquidity/1000).toFixed(1)}K` : 'N/A';

    const priceChange = token.market?.price_change_24h || token.market_data?.price_change_24h || 0;
    const priceEl = document.getElementById('modal-price-change');
    priceEl.textContent = priceChange !== 0 ? `${priceChange > 0 ? '+' : ''}${priceChange.toFixed(2)}%` : 'N/A';
    priceEl.style.color = priceChange >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)';

    const pumpDump = token.pump_dump_score || 0;
    document.getElementById('modal-pump-dump').textContent = `${pumpDump}/100`;

    // Update warnings
    const warningsContainer = document.getElementById('modal-warnings');
    warningsContainer.innerHTML = '';

    if (token.warnings && token.warnings.length > 0) {
        const warningsHTML = token.warnings.slice(0, 5).map(warning => `
            <div style="background: rgba(245, 87, 108, 0.1); border-left: 4px solid var(--accent-danger); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                <div style="font-weight: 600; color: var(--accent-danger); margin-bottom: 0.25rem;">‚ö†Ô∏è Attention</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">${warning}</div>
            </div>
        `).join('');
        warningsContainer.innerHTML = warningsHTML;
    }

    // Update details
    const detailsContainer = document.getElementById('modal-details');
    detailsContainer.innerHTML = `
        <div><strong>Adresse:</strong> <span style="font-family: monospace; color: var(--accent-primary);">${token.address}</span></div>
        <div><strong>Blockchain:</strong> ${token.chain}</div>
        <div><strong>Score de risque:</strong> ${token.risk_score}/100</div>
        <div><strong>S√ªr:</strong> ${token.is_safe ? '‚úÖ Oui' : '‚ö†Ô∏è Non'}</div>
        ${token.security?.is_honeypot ? '<div style="color: var(--accent-danger);"><strong>‚ö†Ô∏è HONEYPOT D√âTECT√â</strong></div>' : ''}
        ${token.is_pump_dump_suspect ? '<div style="color: var(--accent-danger);"><strong>‚ö†Ô∏è PUMP & DUMP SUSPECT</strong></div>' : ''}
    `;

    // Reset Claude analysis
    document.getElementById('claude-analysis').style.display = 'none';
    document.getElementById('claude-loading').style.display = 'none';

    // Show modal
    document.getElementById('token-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Close modal
function closeTokenModal() {
    document.getElementById('token-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentToken = null;
}

// Analyze with Claude AI
async function analyzeWithClaude() {
    if (!currentToken) return;

    const btn = document.getElementById('claude-analyze-btn');
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span><span>Analyse en cours...</span>';

    document.getElementById('claude-loading').style.display = 'block';
    document.getElementById('claude-analysis').style.display = 'none';

    try {
        const response = await fetch('/api/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token_data: currentToken
            })
        });

        const data = await response.json();

        document.getElementById('claude-loading').style.display = 'none';

        if (data.success && data.validation) {
            document.getElementById('claude-analysis').style.display = 'block';
            document.getElementById('claude-result').textContent = data.validation.analysis || data.validation.recommendation || 'Analyse compl√©t√©e.';
        } else {
            alert('Erreur: ' + (data.error || '√âchec de l\'analyse'));
        }
    } catch (error) {
        document.getElementById('claude-loading').style.display = 'none';
        alert('Erreur r√©seau: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ü§ñ</span><span>Analyser avec Claude IA</span>';
    }
}

// Add to favorites
async function addToFavorites() {
    if (!currentToken) return;

    try {
        const response = await fetch('/api/favorites/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token_address: currentToken.address,
                token_chain: currentToken.chain,
                token_data: currentToken
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úÖ Token ajout√© aux favoris !');
        } else {
            alert('Erreur: ' + (data.error || '√âchec'));
        }
    } catch (error) {
        alert('Erreur r√©seau');
    }
}

// Close on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeTokenModal();
    }
});

// Close on background click
document.getElementById('token-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'token-modal') {
        closeTokenModal();
    }
});
</script>
